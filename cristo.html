<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ ASTRA MYSTERIUM - Oracoli Celesti</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@300;400;600&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --font-primary: 'Orbitron', sans-serif;
            --font-secondary: 'Rajdhani', sans-serif;
            --font-display: 'Cinzel', serif;

            --primary: #7DF9FF; --rgb-primary: 125, 249, 255;
            --secondary: #B57EDC; --rgb-secondary: 181, 126, 220;
            --accent: #FFD700; --rgb-accent: 255, 215, 0;
            --success: #66FF99; --rgb-success: 102, 255, 153;
            --danger: #FF6B6B; --rgb-danger: 255, 107, 107;
            --warning: #FFA500; --rgb-warning: 255, 165, 0;
            
            --dark: #03081a; --rgb-dark: 3, 8, 26;
            --darker: #01040f;
            
            --glass-bg: rgba(10, 20, 40, 0.25);
            --glass-border-color: rgba(125, 249, 255, 0.25);
            
            --text: #E0F8FF; --rgb-text: 224, 248, 255;
            --text-dim: rgba(224, 248, 255, 0.65);
            
            --bg-gradient: radial-gradient(ellipse at 70% 30%, rgba(3, 8, 26,1) 0%, rgba(1,4,15,1) 60%, #000005 100%);
            --particle-color: var(--accent);
        }

        /* TEMI (invariati, ma le variabili RGB sono usate di più) */
        .theme-starlight-oracle { /* Default */
            --primary: #7DF9FF; --rgb-primary: 125, 249, 255;
            --secondary: #B57EDC; --rgb-secondary: 181, 126, 220;
            --accent: #FFD700; --rgb-accent: 255, 215, 0;
            --text: #E0F8FF; --rgb-text: 224, 248, 255;
            --dark: #03081a; --rgb-dark: 3, 8, 26;
            --darker: #01040f;
            --glass-bg: rgba(10, 20, 40, 0.3);
            --glass-border-color: rgba(125, 249, 255, 0.3);
            --bg-gradient: radial-gradient(ellipse at 70% 30%, #05102a 0%, #01040f 70%, #000003 100%);
            --particle-color: var(--accent);
        }
        .theme-nebula-dream {
            --primary: #DA70D6; --rgb-primary: 218, 112, 214;
            --secondary: #8A2BE2; --rgb-secondary: 138, 43, 226;
            --accent: #AFEEEE; --rgb-accent: 175, 238, 238;
            --text: #F0FFF0; --rgb-text: 240, 255, 240;
            --dark: #191970; --rgb-dark: 25, 25, 112;
            --darker: #000033;
            --glass-bg: rgba(25, 25, 112, 0.35);
            --glass-border-color: rgba(175, 238, 238, 0.3);
            --bg-gradient: radial-gradient(ellipse at 30% 70%, #2c0046 0%, #100020 60%, #05000a 100%);
            --particle-color: var(--accent);
        }
        .theme-lunar-sanctum {
            --primary: #C0C0C0; --rgb-primary: 192, 192, 192;
            --secondary: #778899; --rgb-secondary: 119, 136, 153;
            --accent: #ADD8E6; --rgb-accent: 173, 216, 230;
            --text: #F5F5F5; --rgb-text: 245, 245, 245;
            --dark: #2F4F4F; --rgb-dark: 47, 79, 79;
            --darker: #101818;
            --glass-bg: rgba(47, 79, 79, 0.3);
            --glass-border-color: rgba(192, 192, 192, 0.35);
            --bg-gradient: radial-gradient(ellipse at 50% 50%, #1c2833 0%, #0b0e11 70%, #000000 100%);
            --particle-color: var(--primary);
        }
        .theme-sunstone-prophecy {
            --primary: #FFD700; --rgb-primary: 255, 215, 0;
            --secondary: #FF8C00; --rgb-secondary: 255, 140, 0;
            --accent: #FFFACD; --rgb-accent: 255, 250, 205;
            --text: #FFFFE0; --rgb-text: 255, 255, 224;
            --dark: #540000; --rgb-dark: 84,0,0;
            --darker: #2a0000;
            --glass-bg: rgba(84,0,0, 0.25);
            --glass-border-color: rgba(255, 215, 0, 0.35);
            --bg-gradient: radial-gradient(ellipse at 50% 20%, #6a2000 0%, #300d00 60%, #100300 100%);
            --particle-color: var(--accent);
        }
        .theme-void-weaver {
            --primary: #483D8B; --rgb-primary: 72, 61, 139;
            --secondary: #800080; --rgb-secondary: 128, 0, 128;
            --accent: #E6E6FA; --rgb-accent: 230, 230, 250;
            --text: #D8BFD8; --rgb-text: 216, 191, 216;
            --dark: #00001a; --rgb-dark: 0,0,26;
            --darker: #000005;
            --glass-bg: rgba(0,0,26,0.4);
            --glass-border-color: rgba(72,61,139,0.3);
            --bg-gradient: radial-gradient(ellipse at 50% 50%, #03000a 0%, #000000 80%);
            --particle-color: var(--accent);
        }
        .theme-astral-garden {
            --primary: #2E8B57; --rgb-primary: 46, 139, 87;
            --secondary: #4682B4; --rgb-secondary: 70, 130, 180;
            --accent: #FFFAF0; --rgb-accent: 255, 250, 240;
            --text: #F0FFF0; --rgb-text: 240,255,240;
            --dark: #003311; --rgb-dark: 0,51,17;
            --darker: #001a08;
            --glass-bg: rgba(0,51,17,0.3);
            --glass-border-color: rgba(46,139,87,0.35);
            --bg-gradient: radial-gradient(ellipse at 20% 80%, #002e1f 0%, #001008 70%, #000000 100%);
            --particle-color: var(--accent);
        }
        .theme-ancient-relic {
            --primary: #DAA520; --rgb-primary: 218,165,32;
            --secondary: #8B4513; --rgb-secondary: 139,69,19;
            --accent: #F5DEB3; --rgb-accent: 245,222,179;
            --text: #FAF0E6; --rgb-text: 250,240,230;
            --dark: #3E2723; --rgb-dark: 62,39,35;
            --darker: #1B0000;
            --glass-bg: rgba(62,39,35,0.3);
            --glass-border-color: rgba(218,165,32,0.3);
            --bg-gradient: radial-gradient(ellipse at 50% 50%, #4a2e1a 0%, #1e120a 70%, #0a0502 100%);
            --particle-color: var(--accent);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 450px; overflow: hidden; }

        body {
            font-family: var(--font-secondary);
            background: var(--bg-gradient);
            color: var(--text);
            position: relative;
            transition: background 0.5s ease, color 0.5s ease;
            perspective: 1200px;
        }
        body.animations-reduced * {
            animation-duration: 0.01ms !important; /* Quasi disabilita animazioni */
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        body.animations-reduced .crystal-lens {
            backdrop-filter: blur(5px) saturate(100%) brightness(1); /* Effetto ridotto */
            box-shadow: 0 5px 20px rgba(0,0,0, 0.15), inset 0 0 10px rgba(var(--rgb-primary), 0.05);
        }
        body.animations-reduced .celestial-glow {
            text-shadow: 0 0 8px var(--primary), 0 0 15px rgba(var(--rgb-secondary), 0.3);
        }
         body.animations-reduced h1.celestial-glow, 
         body.animations-reduced h2.celestial-glow, 
         body.animations-reduced .game-title.celestial-glow, 
         body.animations-reduced .stats-title.celestial-glow {
            text-shadow: 0 0 8px var(--accent), 0 0 15px rgba(var(--rgb-primary), 0.4);
        }
        body.animations-reduced .celestial-border {
            box-shadow: inset 0 0 5px rgba(var(--rgb-primary), 0.1), 0 0 8px rgba(var(--rgb-primary), 0.15);
        }


        /* SISTEMA DI SFONDO COSMICO */
        .bg-system { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -3; overflow: hidden; }
        .particle-field { position: absolute; width: 100%; height: 100%; opacity: 0.5; } /* Opacità leggermente ridotta */
        .particle {
            position: absolute;
            background: var(--particle-color, var(--accent));
            border-radius: 50%;
            pointer-events: none;
            animation: starTwinkle 12s ease-in-out infinite; /* Durata leggermente aumentata */
            /* will-change rimosso da qui, applicato da JS se necessario o per animazioni più complesse */
            box-shadow: 0 0 4px var(--particle-color), 0 0 8px var(--particle-color); /* Ombra ridotta */
        }
        @keyframes starTwinkle {
            0%, 100% { transform: translateY(var(--y-end, 15px)) translateX(var(--x-end, 8px)) scale(0.6); opacity: var(--o-start, 0.2); }
            50% { transform: translateY(0px) translateX(0px) scale(1); opacity: var(--o-mid, 0.7); 
                  box-shadow: 0 0 6px var(--particle-color), 0 0 12px var(--particle-color), 0 0 15px var(--accent); }
        }
        .grid-overlay {
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background-image: 
                linear-gradient(rgba(var(--rgb-primary), 0.02) 1px, transparent 1px), /* Opacità ridotta */
                linear-gradient(90deg, rgba(var(--rgb-primary), 0.02) 1px, transparent 1px);
            background-size: 180px 180px; /* Dimensione aumentata */
            animation: celestialGridFlow 120s linear infinite; /* Durata aumentata */
            opacity: 0.1;
        }
        @keyframes celestialGridFlow {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(180px, 180px) rotate(10deg); } /* Rotazione ridotta */
        }
        .energy-waves {
            position: absolute; width: 100%; height: 100%;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(var(--rgb-secondary), 0.03) 0%, transparent 65%), /* Trasparenza aumentata */
                radial-gradient(ellipse at 80% 30%, rgba(var(--rgb-primary), 0.02) 0%, transparent 60%),
                radial-gradient(circle at 50% 50%, rgba(var(--rgb-accent), 0.01) 0%, transparent 75%);
            animation: nebulaPulse 25s ease-in-out infinite; /* Durata aumentata */
            mix-blend-mode: screen;
        }
        @keyframes nebulaPulse {
            0%, 100% { opacity: 0.15; transform: scale(1) rotate(0deg); }
            50% { opacity: 0.4; transform: scale(1.03) rotate(2deg); } /* Movimento ridotto */
        }

        /* EFFETTO CRISTALLO DIVINATORIO */
        .crystal-lens {
            background: var(--glass-bg);
            backdrop-filter: blur(10px) saturate(130%) brightness(1.1);
            border: 1px solid var(--glass-border-color);
            border-radius: 22px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 35px rgba(0,0,0, 0.2), 
                        inset 0 0 12px rgba(var(--rgb-primary), 0.08),
                        inset 0 0 25px rgba(var(--rgb-secondary), 0.04);
            transition: transform 0.35s cubic-bezier(0.165, 0.84, 0.44, 1), box-shadow 0.35s ease;
            /* will-change: transform, box-shadow; rimosso, troppo generico */
        }
        .crystal-lens::before {
            content: ''; position: absolute; top: -20%; left: -150%; width: 70%; height: 140%;
            background: linear-gradient(110deg, transparent 20%, rgba(var(--rgb-text), 0.06) 45%, rgba(var(--rgb-text), 0.1) 55%, transparent 80%);
            transform: rotate(30deg);
            transition: left 0.8s cubic-bezier(0.23, 1, 0.32, 1); /* Durata leggermente ridotta */
        }
        .crystal-lens:hover::before { left: 150%; }
        .crystal-lens:hover {
            /* transform: translateY(-5px) scale(1.01); rimosso per ridurre repaint su hover */
            box-shadow: 0 12px 45px rgba(var(--rgb-primary), 0.12), 
                        0 4px 18px rgba(0,0,0,0.18),
                        inset 0 0 18px rgba(var(--rgb-primary), 0.12),
                        inset 0 0 35px rgba(var(--rgb-secondary), 0.06);
        }

        /* BAGLIORE CELESTIALE */
        .celestial-glow {
            color: var(--primary);
            text-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 18px var(--accent), 0 0 25px rgba(var(--rgb-secondary), 0.4);
            animation: celestialShimmer 5s ease-in-out infinite alternate; /* Durata aumentata */
        }
        h1.celestial-glow, h2.celestial-glow, .game-title.celestial-glow, .stats-title.celestial-glow {
            color: var(--accent);
            text-shadow: 0 0 5px var(--accent), 0 0 10px var(--accent), 0 0 22px var(--primary), 0 0 30px rgba(var(--rgb-secondary), 0.5);
        }
        @keyframes celestialShimmer { /* Intensità leggermente ridotta */
            from { filter: brightness(0.98) saturate(0.95); text-shadow: 0 0 4px var(--primary), 0 0 8px var(--primary), 0 0 15px var(--accent), 0 0 22px rgba(var(--rgb-secondary), 0.35); }
            to { filter: brightness(1.1) saturate(1.05); text-shadow: 0 0 6px var(--primary), 0 0 12px var(--primary), 0 0 20px var(--accent), 0 0 30px rgba(var(--rgb-secondary), 0.5); }
        }
        .celestial-border {
            border: 2px solid var(--primary);
            box-shadow: inset 0 0 8px rgba(var(--rgb-primary), 0.12), 0 0 10px rgba(var(--rgb-primary), 0.2), 0 0 18px rgba(var(--rgb-accent), 0.15), 0 0 25px rgba(var(--rgb-secondary),0.08);
            animation: borderShimmer 7s ease-in-out infinite alternate; /* Durata aumentata */
        }
        @keyframes borderShimmer { /* Intensità leggermente ridotta */
            from { border-color: var(--primary); box-shadow: inset 0 0 6px rgba(var(--rgb-primary), 0.08), 0 0 8px rgba(var(--rgb-primary), 0.15), 0 0 12px rgba(var(--rgb-accent), 0.12), 0 0 20px rgba(var(--rgb-secondary),0.04); }
            to { border-color: var(--accent); box-shadow: inset 0 0 10px rgba(var(--rgb-primary), 0.15), 0 0 12px rgba(var(--rgb-primary), 0.25), 0 0 20px rgba(var(--rgb-accent), 0.2), 0 0 30px rgba(var(--rgb-secondary),0.12); }
        }

        /* SCHERMATA LOGIN */
        .login-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 10000; background: var(--bg-gradient); padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .login-screen.hidden { display: none !important; }
        .login-container { max-width:  800px; width: 100%; padding: 3.5rem 3rem; text-align: center; position: relative; animation: portalPulse 20s ease-in-out infinite; /* Durata aumentata */ }
        @keyframes portalPulse {
            0%, 100% { transform: translateY(0px) scale(1); box-shadow: 0 0 25px rgba(var(--rgb-primary),0.15); }
            25% { transform: translateY(-8px) scale(1.005); box-shadow: 0 0 35px rgba(var(--rgb-accent),0.25); }
            50% { transform: translateY(-4px) scale(1); box-shadow: 0 0 30px rgba(var(--rgb-secondary),0.2); }
            75% { transform: translateY(-10px) scale(1.01); box-shadow: 0 0 40px rgba(var(--rgb-primary),0.3); }
        }
        .login-title { font-family: var(--font-display); font-size: 3.5rem; font-weight: 700; background: linear-gradient(70deg, var(--accent), var(--primary), var(--secondary), var(--accent)); background-size: 300% 300%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: cosmicGradientShift 14s ease-in-out infinite; margin-bottom: 1.5rem; filter: drop-shadow(0 0 15px rgba(var(--rgb-accent), 0.4)); }
        @keyframes cosmicGradientShift {
            0%, 100% { background-position: 0% 50%; filter: drop-shadow(0 0 15px rgba(var(--rgb-accent), 0.4));}
            50% { background-position: 100% 50%; filter: drop-shadow(0 0 22px rgba(var(--rgb-primary), 0.5));}
        }
        .login-subtitle { font-family: var(--font-secondary); font-size: 1.4rem; color: var(--text-dim); margin-bottom: 3rem; font-weight: 400; animation: etherealGlow 7s ease-in-out infinite alternate; letter-spacing: 0.5px; }
        @keyframes etherealGlow {
            from { text-shadow: 0 0 6px rgba(var(--rgb-text), 0.25); opacity: 0.8; }
            to { text-shadow: 0 0 12px rgba(var(--rgb-text), 0.45); opacity: 1; }
        }
        .form-group { margin-bottom: 2rem; position: relative; }
        .form-input { width: 100%; padding: 1.4rem 1.8rem; background: rgba(var(--rgb-darker), 0.55); border: 2px solid rgba(var(--rgb-primary),0.15); border-radius: 12px; color: var(--text); font-size: 1.05rem; font-family: var(--font-secondary); transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; outline: none; backdrop-filter: blur(4px); }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(var(--rgb-primary), 0.35), inset 0 0 6px rgba(var(--rgb-primary),0.08); background: rgba(var(--rgb-darker), 0.6); }
        .form-input::placeholder { color: var(--text-dim); opacity: 0.6; }

        /* BOTTONI */
        .btn { padding: 1.3rem 3rem; border: 1px solid transparent; border-radius: 10px; font-family: var(--font-primary); font-size: 1.15rem; font-weight: 500; cursor: pointer; transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.25s ease, background 0.25s ease, border-color 0.25s ease; position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 1.5px; display: inline-block; text-decoration: none; background-clip: padding-box; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(70%); transform: none !important; box-shadow: none !important; }
        .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(var(--rgb-text), 0.12); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease; opacity: 0; z-index: 0; }
        .btn:hover::before { width: 280%; height: 280%; opacity: 1; }
        .btn span { position: relative; z-index: 1; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--darker); border-color: rgba(var(--rgb-accent),0.25); box-shadow: 0 4px 18px rgba(var(--rgb-primary), 0.2), inset 0 1px 1px rgba(var(--rgb-text),0.15); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px) scale(1.02); box-shadow: 0 7px 25px rgba(var(--rgb-primary), 0.3), 0 0 12px rgba(var(--rgb-accent),0.15), inset 0 1px 2px rgba(var(--rgb-text),0.25); border-color: var(--accent); }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary), var(--danger)); color: var(--text); border-color: rgba(var(--rgb-primary),0.15); box-shadow: 0 4px 18px rgba(var(--rgb-secondary), 0.2), inset 0 1px 1px rgba(var(--rgb-text),0.1); }
        .btn-secondary:hover:not(:disabled) { transform: translateY(-3px) scale(1.02); box-shadow: 0 7px 25px rgba(var(--rgb-secondary), 0.3), 0 0 12px rgba(var(--rgb-danger),0.15), inset 0 1px 2px rgba(var(--rgb-text),0.2); border-color: var(--danger); }
        .btn-full { width: 100%; margin-bottom: 1.5rem; }
        .auth-toggle { font-family: var(--font-secondary); color: var(--accent); cursor: pointer; text-decoration: none; border-bottom: 1px dashed rgba(var(--rgb-accent),0.4); transition: color 0.25s ease, border-color 0.25s ease, text-shadow 0.25s ease; margin-top: 1.5rem; font-weight: 600; display: inline-block; padding-bottom: 3px; }
        .auth-toggle:hover { color: var(--primary); border-bottom-color: var(--primary); text-shadow: 0 0 8px var(--primary); }
        .error-message, .success-message { padding: 1.3rem; border-radius: 10px; margin-top: 1.5rem; font-weight: 600; backdrop-filter: blur(4px); border-left-width: 6px; font-size: 0.95rem; line-height: 1.5; }
        .error-message { background: rgba(var(--rgb-danger), 0.12); border-left-color: var(--danger); color: var(--danger); text-shadow: 0 0 6px rgba(var(--rgb-danger), 0.35); }
        .success-message { background: rgba(var(--rgb-success), 0.12); border-left-color: var(--success); color: var(--success); text-shadow: 0 0 6px rgba(var(--rgb-success), 0.35); }

        /* INTERFACCIA GIOCO */
        .game-wrapper { display: none; min-height:  450px; overflow-y: auto; }
        .game-wrapper.active { display: block; }
        .main-container { max-width: 800px; margin: 0 auto; padding: 3rem 2.5rem; min-height: 450px; }
        .header { text-align: center; margin-bottom: 4rem; position: relative; }
        .main-title { font-family: var(--font-display); font-size: clamp(3rem, 10vw, 6rem); font-weight: 700; background: linear-gradient(70deg, var(--accent), var(--primary), var(--secondary), var(--accent)); background-size: 300% 300%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: cosmicGradientShift 14s ease-in-out infinite; margin-bottom: 1.5rem; filter: drop-shadow(0 0 18px rgba(var(--rgb-accent), 0.55)); }
        .subtitle { font-family: var(--font-secondary); font-size: 1.8rem; color: var(--text-dim); font-weight: 400; animation: etherealGlow 7s ease-in-out infinite alternate; letter-spacing: 1px; }

        /* NAVIGAZIONE */
        .nav-bar { position: fixed; top: 25px; right: 25px; z-index: 1000; display: flex; gap: 1.3rem; flex-wrap: wrap; }
        .nav-btn { padding: 1rem 1.8rem; background: rgba(var(--rgb-dark), 0.55); backdrop-filter: blur(7px); border: 1px solid rgba(var(--rgb-primary),0.25); border-radius: 8px; color: var(--primary); text-decoration: none; font-family: var(--font-primary); font-weight: 500; font-size: 0.9rem; transition: background 0.25s ease, color 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease; cursor: pointer; position: relative; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.18); }
        .nav-btn::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(var(--rgb-accent),0.08), rgba(var(--rgb-primary),0.15)); opacity: 0; transition: opacity 0.35s ease; z-index: -1; }
        .nav-btn:hover::before { opacity: 1; }
        .nav-btn:hover { background: rgba(var(--rgb-primary), 0.12); color: var(--accent); transform: translateY(-2px) scale(1.015); box-shadow: 0 0 15px rgba(var(--rgb-primary), 0.45), 0 4px 12px rgba(0,0,0,0.22); border-color: var(--accent); }

        /* PANNELLO UTENTE */
        .user-panel { position: fixed; top: 25px; left: 25px; z-index: 1000; padding: 1.3rem 1.5rem; background: rgba(var(--rgb-dark), 0.65); backdrop-filter: blur(9px); border: 1px solid rgba(var(--rgb-secondary),0.25); border-radius: 12px; display: none; align-items: center; gap: 1.3rem; animation: panelSlideIn 0.55s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 4px 18px rgba(0,0,0,0.18); }
        .user-panel.active { display: flex; }
        @keyframes panelSlideIn { from { opacity: 0; transform: translateX(-115%) rotate(-2.5deg); } to { opacity: 1; transform: translateX(0) rotate(0deg); } }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(160deg, var(--primary), var(--secondary), var(--accent)); background-size: 180% 180%; animation: avatarShine 9s ease-in-out infinite; display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-weight: 700; font-size: 1.5rem; color: var(--darker); border: 2px solid var(--accent); box-shadow: 0 0 12px rgba(var(--rgb-accent), 0.45), 0 0 22px rgba(var(--rgb-primary),0.25); }
        @keyframes avatarShine { 0%, 100% { background-position: 0% 50%; transform: scale(1) rotate(0deg); } 50% { background-position: 100% 50%; transform: scale(1.05) rotate(4deg); } }
        #userName { font-family: var(--font-primary); font-weight: 500; }
        #userEmail { font-family: var(--font-secondary); font-size: 0.85rem; }

        /* GRIGLIA GIOCHI */
        .games-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2.8rem; margin-bottom: 4rem; }
        .game-card { padding: 0; text-align: center; cursor: pointer; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.4s ease; position: relative; min-height: 420px; display: flex; flex-direction: column; justify-content: flex-end; border-radius: 18px; overflow: hidden; background-color: rgba(var(--rgb-dark), 0.75); border: 1px solid rgba(var(--rgb-primary),0.18); box-shadow: 0 7px 22px rgba(0,0,0,0.28); }
        .game-card-background { position: absolute; top:0; left:0; width:100%; height: 100%; background-size: cover; background-position: center; opacity: 0.25; transition: opacity 0.35s ease, transform 0.35s ease; z-index: 0; }
        .game-card[data-game="numberQuest"] .game-card-background { background-image: url('https://www.transparenttextures.com/patterns/stardust.png'), linear-gradient(to bottom, rgba(var(--rgb-primary),0.08), rgba(var(--rgb-secondary),0.18)); }
        .game-card[data-game="memoryChallenge"] .game-card-background { background-image: url('https://www.transparenttextures.com/patterns/cosmic.png'), linear-gradient(to bottom, rgba(var(--rgb-secondary),0.08), rgba(var(--rgb-accent),0.12)); }
        .game-card-content { position: relative; z-index: 1; padding: 2rem 1.5rem; background: linear-gradient(to top, rgba(var(--rgb-darker), 0.92) 20%, rgba(var(--rgb-darker), 0.55) 70%, transparent 100%); border-top: 1px solid rgba(var(--rgb-primary),0.12); }
        .game-card:hover .game-card-background { opacity: 0.45; transform: scale(1.04); }
        .game-card:hover { transform: translateY(-12px) rotateX(4deg) rotateY(-1.5deg); box-shadow: 0 18px 45px rgba(var(--rgb-primary), 0.18), 0 4px 12px rgba(0,0,0,0.22); }
        .game-icon { font-size: 3.5rem; margin-bottom: 1rem; animation: iconPulseMystic 5.5s ease-in-out infinite; color: var(--primary); text-shadow: 0 0 12px var(--primary), 0 0 22px var(--accent); }
        @keyframes iconPulseMystic { 0%, 100% { transform: translateY(0px) scale(1); opacity: 0.85; } 50% { transform: translateY(-7px) scale(1.08); opacity: 1; } }
        .game-title { font-family: var(--font-display); font-size: 1.6rem; font-weight: 700; color: var(--accent); margin-bottom: 0.8rem; text-shadow: 0 0 8px var(--accent), 0 0 4px var(--text); }
        .game-description { color: var(--text-dim); line-height: 1.6; font-size: 0.9rem; font-weight: 400; font-family: var(--font-secondary); }
        
        /* ORACLE & CONSTELLATION CALLOUTS */
        .celestial-callout { padding: 2rem; margin-bottom: 2.5rem; text-align: center; border-radius: 15px; background: linear-gradient(135deg, rgba(var(--rgb-secondary),0.12), rgba(var(--rgb-primary),0.08)); border: 1px solid rgba(var(--rgb-accent),0.18); cursor: default; transition: box-shadow 0.3s ease, transform 0.3s ease; }
        .celestial-callout:hover { transform: scale(1.015); box-shadow: 0 0 18px rgba(var(--rgb-accent),0.18); }
        .celestial-callout-title { font-family: var(--font-display); font-size: 1.8rem; color: var(--accent); margin-bottom: 0.5rem; }
        .celestial-callout-text { color: var(--text-dim); font-size: 1rem; line-height: 1.5; }
        #dailyConstellationIcon { font-size: 2em; display: block; margin-bottom: 0.3em; }


        /* STATS PANEL */
        .stats-panel { padding: 3rem; margin-bottom: 4rem; position: relative; }
        .stats-title { font-family: var(--font-display); font-size: 2.8rem; text-align: center; color: var(--accent); margin-bottom: 3rem; text-shadow: 0 0 18px var(--accent), 0 0 8px var(--primary); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 2rem; }
        .stat-card { padding: 2.5rem 2rem; text-align: center; background: rgba(var(--rgb-darker), 0.65); border-radius: 12px; border: 1px solid rgba(var(--rgb-secondary),0.22); transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; position: relative; overflow: hidden; backdrop-filter: blur(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.18); }
        .stat-card::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: radial-gradient(circle, rgba(var(--rgb-primary), 0.18) 0%, transparent 70%); border-radius: 50%; transform: translate(-50%, -50%); transition: all 0.6s cubic-bezier(0.19, 1, 0.22, 1); opacity: 0; z-index: 0; }
        .stat-card:hover::before { width: 350%; height: 350%; opacity: 1; }
        .stat-card:hover { transform: translateY(-5px) scale(1.015); box-shadow: 0 0 22px rgba(var(--rgb-primary), 0.28), 0 7px 18px rgba(0,0,0,0.22); border-color: var(--primary); }
        .stat-value, .stat-label { position: relative; z-index: 1; }
        .stat-value { font-family: var(--font-primary); font-size: 3rem; font-weight: 700; color: var(--primary); margin-bottom: 0.8rem; text-shadow: 0 0 15px var(--primary), 0 0 6px var(--accent); animation: valueShine 5.5s ease-in-out infinite alternate; }
        @keyframes valueShine { from { filter: brightness(0.95) saturate(0.85); transform: scale(1); } to { filter: brightness(1.15) saturate(1.15); transform: scale(1.025); } }
        .stat-label { font-family: var(--font-secondary); color: var(--text-dim); font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; font-size: 0.95rem; }

        /* GAME INTERFACE */
        .game-interface { padding: 3.5rem; margin-bottom: 3rem; position: relative; }
        .game-header { text-align: center; margin-bottom: 3rem; }
        .game-title-main { font-family: var(--font-display); font-size: 3rem; color: var(--accent); margin-bottom: 1.3rem; text-shadow: 0 0 20px var(--accent), 0 0 8px var(--primary); }
        .game-header p { font-family: var(--font-secondary); font-size: 1.1rem; color: var(--text-dim); }
        .difficulty-selector { display: flex; justify-content: center; gap: 2rem; margin: 3rem 0; flex-wrap: wrap; }
        .difficulty-btn { padding: 1.5rem 2.5rem; border: 2px solid rgba(var(--rgb-primary),0.25); border-radius: 10px; background: rgba(var(--rgb-dark), 0.45); color: var(--text); cursor: pointer; transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease, border-color 0.25s ease, color 0.25s ease; font-family: var(--font-primary); font-weight: 500; text-align: center; min-width: 180px; backdrop-filter: blur(4px); position: relative; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.12); }
        .difficulty-btn small { font-family: var(--font-secondary); font-size: 0.8em; opacity: 0.8; display: block; margin-top: 0.3em;}
        .difficulty-btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: radial-gradient(circle, rgba(var(--rgb-accent),0.22) 0%, transparent 70%); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.45s ease, height 0.45s ease, opacity 0.45s ease; opacity: 0; }
        .difficulty-btn.active::before, .difficulty-btn:hover::before { width: 250%; height: 250%; opacity: 1; }
        .difficulty-btn.active, .difficulty-btn:hover { border-color: var(--accent); background: rgba(var(--rgb-accent), 0.08); transform: translateY(-4px) scale(1.025); box-shadow: 0 0 18px rgba(var(--rgb-accent), 0.35), 0 5px 12px rgba(0,0,0,0.18); color: var(--accent); }
        .difficulty-easy.active, .difficulty-easy:hover { border-color: var(--success); background: rgba(var(--rgb-success),0.08); box-shadow: 0 0 18px rgba(var(--rgb-success),0.35); color: var(--success); }
        .difficulty-normal.active, .difficulty-normal:hover { border-color: var(--warning); background: rgba(var(--rgb-warning),0.08); box-shadow: 0 0 18px rgba(var(--rgb-warning),0.35); color: var(--warning); }
        .difficulty-hard.active, .difficulty-hard:hover { border-color: var(--danger); background: rgba(var(--rgb-danger),0.08); box-shadow: 0 0 18px rgba(var(--rgb-danger),0.35); color: var(--danger); }

        /* GAME AREA */
        .game-area { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin: 3rem 0; }
        .control-panel { padding: 3rem; position: relative; }
        .control-panel h3 { font-family: var(--font-display); }
        .game-input { width: 100%; padding: 1.8rem; background: rgba(var(--rgb-darker), 0.75); border: 2px solid rgba(var(--rgb-primary),0.25); border-radius: 8px; color: var(--text); font-size: 1.6rem; font-family: var(--font-primary); text-align: center; margin-bottom: 2.5rem; transition: border-color 0.25s ease, box-shadow 0.25s ease, background-color 0.25s ease; backdrop-filter: blur(3px); box-shadow: inset 0 0 8px rgba(0,0,0,0.25); }
        .game-input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(var(--rgb-primary), 0.45), inset 0 0 10px rgba(var(--rgb-primary),0.18); outline: none; }
        .hint-display { text-align: center; font-family: var(--font-secondary); font-size: 1.3rem; font-style: italic; font-weight: 400; color: var(--primary); margin-top: 2.5rem; min-height: 3rem; line-height: 1.6; text-shadow: 0 0 10px var(--primary); border: 1px dashed rgba(var(--rgb-primary),0.18); padding: 1rem; border-radius: 8px; background: rgba(var(--rgb-dark),0.15); }
        .history-panel { padding: 2.5rem; max-height: 500px; overflow-y: auto; border: 1px solid rgba(var(--rgb-secondary),0.18); background: rgba(var(--rgb-darker),0.25) url('https://www.transparenttextures.com/patterns/old-paper.png'); background-blend-mode: overlay; border-radius: 10px; }
        .history-panel h3 { font-family: var(--font-display); }
        .history-item { padding: 1.3rem 1.5rem; margin-bottom: 1.2rem; background: rgba(var(--rgb-dark), 0.55); border-radius: 8px; border-left: 5px solid var(--primary); animation: historyEntry 0.45s ease-out; backdrop-filter: blur(2px); box-shadow: 0 2px 6px rgba(0,0,0,0.18); font-family: var(--font-secondary); }
        .history-item span:first-child { font-weight: 600; }
        @keyframes historyEntry { from { opacity: 0; transform: translateX(35px) scale(0.92); } to { opacity: 1; transform: translateX(0) scale(1); } }

        /* PROGRESS BAR */
        .progress-container { margin: 3rem 0; padding: 3rem; text-align: center; position: relative; }
        .progress-container h3 { font-family: var(--font-display); }
        .progress-bar { width: 100%; height: 24px; background: rgba(var(--rgb-darker), 0.55); border-radius: 12px; overflow: hidden; margin: 1.8rem 0; position: relative; border: 2px solid rgba(var(--rgb-primary),0.35); box-shadow: inset 0 0 8px rgba(0,0,0,0.35); }
        .progress-fill { height: 100%; background: linear-gradient(120deg, var(--primary), var(--accent), var(--secondary), var(--primary)); background-size: 300% 100%; border-radius: 10px; transition: width 0.9s cubic-bezier(0.23, 1, 0.32, 1); position: relative; animation: cosmicFlow 9s linear infinite; box-shadow: 0 0 8px var(--primary), 0 0 18px var(--accent); }
        @keyframes cosmicFlow { 0% { background-position: -300% 0; filter: brightness(0.85) saturate(0.75); } 50% { filter: brightness(1.15) saturate(1.25); } 100% { background-position: 300% 0; filter: brightness(0.85) saturate(0.75); } }

        /* TIMER */
        .timer-display { font-family: var(--font-primary); font-size: 4rem; font-weight: 700; color: var(--secondary); text-align: center; margin: 1.8rem 0; text-shadow: 0 0 25px var(--secondary), 0 0 10px var(--accent); animation: celestialClockPulse 2.2s ease-in-out infinite; }
        @keyframes celestialClockPulse { 0%, 100% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.04); opacity: 1; } }
        .timer-warning { color: var(--danger) !important; animation: celestialWarning 0.65s ease-in-out infinite; text-shadow: 0 0 22px var(--danger), 0 0 8px var(--text) !important; }
        @keyframes celestialWarning { 0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.75; } 25% { transform: scale(1.08) rotate(-1.2deg); opacity: 1; } 75% { transform: scale(1.08) rotate(1.2deg); opacity: 1; } }

        /* IMPOSTAZIONI */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 2.5rem; margin: 3rem 0; }
        .setting-group { padding: 2.5rem; background: rgba(var(--rgb-darker), 0.55); border-radius: 12px; border: 1px solid rgba(var(--rgb-secondary),0.22); backdrop-filter: blur(5px); transition: transform 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.18); }
        .setting-group:hover { transform: translateY(-4px) rotateX(1.5deg); box-shadow: 0 8px 25px rgba(var(--rgb-secondary),0.12), 0 3px 8px rgba(0,0,0,0.12); }
        .setting-title { font-family: var(--font-display); font-size: 1.8rem; color: var(--accent); margin-bottom: 2rem; text-shadow: 0 0 12px var(--accent); border-bottom: 1px solid rgba(var(--rgb-accent),0.18); padding-bottom: 0.8rem; }
        .setting-group label { font-family: var(--font-secondary); }
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 1.3rem; margin: 2rem 0; }
        .theme-option { aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, border-color 0.3s ease; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0.5rem; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.18); }
        .theme-option::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(var(--rgb-text), 0.08); border-radius: 50%; transition: all 0.45s cubic-bezier(0.34, 1.56, 0.64, 1); transform: translate(-50%, -50%); }
        .theme-option:hover::before, .theme-option.active::before { width: 160%; height: 160%; }
        .theme-option:hover, .theme-option.active { border-color: var(--accent); transform: translateY(-4px) scale(1.08); box-shadow: 0 0 18px rgba(var(--rgb-accent), 0.55), 0 4px 10px rgba(0,0,0,0.22); }
        .theme-icon { font-size: 1.8rem; margin-bottom: 0.3rem; z-index: 1; position: relative; animation: themeSymbolPulse 4.5s ease-in-out infinite; filter: drop-shadow(0 0 5px currentColor); }
        .theme-name { font-family: var(--font-secondary); font-size: 0.65rem; font-weight: 600; color: var(--text); z-index: 1; position: relative; text-transform: uppercase; letter-spacing: 0.8px; }
        @keyframes themeSymbolPulse { 0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.85; } 50% { transform: scale(1.12) rotate(4deg); opacity: 1; } }
        .theme-starlight-oracle { background: radial-gradient(circle, #0a183c, #01040f); } .theme-starlight-oracle .theme-icon { color: #7DF9FF; }
        .theme-nebula-dream { background: radial-gradient(circle, #3a005a, #100020); } .theme-nebula-dream .theme-icon { color: #DA70D6; }
        .theme-lunar-sanctum { background: radial-gradient(circle, #3c4f4f, #101818); } .theme-lunar-sanctum .theme-icon { color: #C0C0C0; }
        .theme-sunstone-prophecy { background: radial-gradient(circle, #7a2800, #300d00); } .theme-sunstone-prophecy .theme-icon { color: #FFD700; }
        .theme-void-weaver { background: radial-gradient(circle, #00002a, #000005); } .theme-void-weaver .theme-icon { color: #483D8B; }
        .theme-astral-garden { background: radial-gradient(circle, #004d22, #001a08); } .theme-astral-garden .theme-icon { color: #2E8B57; }
        .theme-ancient-relic { background: radial-gradient(circle, #5a3e2a, #1B0000); } .theme-ancient-relic .theme-icon { color: #DAA520; }
        .slider { width: 100%; height: 8px; border-radius: 4px; background: rgba(var(--rgb-text), 0.12); outline: none; margin: 2rem 0 1rem 0; cursor: pointer; transition: background 0.25s ease; appearance: none; -webkit-appearance: none; }
        .slider:hover { background: rgba(var(--rgb-text), 0.22); }
        .slider::-webkit-slider-thumb { appearance: none; -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--primary); cursor: pointer; box-shadow: 0 0 10px rgba(var(--rgb-primary), 0.65), 0 0 0 3px rgba(var(--rgb-dark),0.45); transition: transform 0.25s ease, box-shadow 0.25s ease; border: 2px solid var(--dark); }
        .slider::-webkit-slider-thumb:hover { transform: scale(1.18); box-shadow: 0 0 15px rgba(var(--rgb-primary), 0.85), 0 0 0 4px rgba(var(--rgb-dark),0.35); }
        .slider::-moz-range-thumb { width: 24px; height: 24px; border-radius: 50%; background: var(--primary); cursor: pointer; box-shadow: 0 0 10px rgba(var(--rgb-primary),0.65),0 0 0 3px rgba(var(--rgb-dark),0.45); border: 2px solid var(--dark); }
        .slider::-moz-range-thumb:hover { transform: scale(1.18); box-shadow: 0 0 15px rgba(var(--rgb-primary),0.85),0 0 0 4px rgba(var(--rgb-dark),0.35); }

        /* MEMORY GAME */
        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin: 3rem auto; max-width:  800px; }
        .memory-card { aspect-ratio: 3 / 4.5; background: transparent; border: none; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 2.8rem; cursor: pointer; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); position: relative; transform-style: preserve-3d; box-shadow: 0 4px 12px rgba(0,0,0,0.18); }
        .memory-card .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; padding: 1rem; box-sizing: border-box; border: 1px solid rgba(var(--rgb-primary),0.18); }
        .memory-card .card-front { background: linear-gradient(160deg, rgba(var(--rgb-dark),0.85), rgba(var(--rgb-darker),0.92)), url('https://www.transparenttextures.com/patterns/worn-dots.png'); background-blend-mode: overlay; color: var(--primary); }
        .memory-card .card-front::after { content: '✧'; font-size: 3rem; opacity: 0.45; text-shadow: 0 0 8px var(--primary); }
        .memory-card .card-back { background: linear-gradient(160deg, rgba(var(--rgb-accent),0.18), rgba(var(--rgb-primary),0.08)), var(--dark); color: var(--accent); transform: rotateY(180deg); font-family: var(--font-display); }
        .memory-card .card-back .symbol-text { font-size: 0.8rem; margin-top: 0.5rem; font-family: var(--font-secondary); color: var(--text-dim); }
        .memory-card:hover:not(.flipped):not(.matched) { transform: translateY(-7px) scale(1.025) rotateX(2.5deg); box-shadow: 0 8px 22px rgba(var(--rgb-primary),0.12); }
        .memory-card.flipped { transform: rotateY(180deg); }
        .memory-card.matched { transform: rotateY(0deg) scale(1.04); box-shadow: 0 0 22px var(--success), 0 0 8px var(--accent); opacity: 0.75; cursor: default; }
        .memory-card.matched .card-back { background: linear-gradient(160deg, var(--success), var(--primary)); color: var(--darker); border-color: var(--success); }
        .memory-card.matched .card-back .symbol-text { color: rgba(var(--rgb-darker),0.8); }

        /* RESPONSIVE (invariato) */
        @media (max-width:  800px) { :root { font-size: 14px; } .login-container { padding: 2.5rem 1.5rem; max-width: 90%; } .login-title { font-size: 2.8rem; } .main-container { padding: 2rem 1rem; } .games-grid { grid-template-columns: 1fr; gap: 2rem; } .game-card { min-height: 380px; } .game-area { grid-template-columns: 1fr; gap: 2rem; } .stats-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; } .stat-value { font-size: 2.2rem; } .difficulty-selector { gap: 1rem; } .difficulty-btn { padding: 1.2rem 1.8rem; min-width: 150px; font-size: 0.95rem; } .nav-bar { top:15px; right:15px; gap: 0.8rem; } .nav-btn { padding: 0.8rem 1.2rem; font-size: 0.85rem; } .user-panel { top:15px; left:15px; padding: 1rem; gap: 1rem; } .user-avatar { width: 40px; height: 40px; font-size: 1.2rem; } .theme-grid { grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 1rem; } .theme-icon { font-size: 1.5rem; } .memory-grid { grid-template-columns: repeat(3, 1fr); gap: 1rem; max-width: 95%; } .memory-card { font-size: 2rem; } .timer-display { font-size: 3rem; } .game-title-main { font-size: 2.2rem; } .main-title { font-size: clamp(2.5rem, 12vw, 4rem); } .subtitle { font-size: 1.3rem; } .setting-group { padding: 1.8rem; } .setting-title { font-size: 1.5rem; } }
        @media (max-width:  800px) { :root { font-size: 13px; } .login-title { font-size: 2.2rem; } .subtitle { font-size: 1.1rem; } .btn { padding: 1rem 2rem; font-size: 1rem; letter-spacing: 1px; } .game-icon { font-size: 3rem; } .game-title { font-size: 1.3rem; } .game-description { font-size: 0.85rem; } .memory-grid { grid-template-columns: repeat(2, 1fr); } .stat-card { padding: 1.5rem; } .stat-value { font-size: 1.8rem; } .stat-label { font-size: 0.8rem; } }

        /* UTILITIES */
        .hidden { display: none !important; } .text-center { text-align: center; } .mb-2 { margin-bottom: 2rem; } .mt-2 { margin-top: 2rem; }
        .nav-text-mobile-hidden { display: inline; }
        @media (max-width:  800px) { .nav-text-mobile-hidden { display: none; } }


        /* SPINNER */
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(var(--rgb-text), 0.22); border-radius: 50%; border-top-color: var(--primary); border-right-color: var(--primary); animation: celestialSpin 0.85s linear infinite; margin-right: 10px; }
        @keyframes celestialSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* NOTIFICHE */
        .notification { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: rgba(var(--rgb-darker), 0.75); backdrop-filter: blur(10px) saturate(140%); border: 1px solid rgba(var(--rgb-primary),0.25); border-radius: 10px; padding: 1.2rem 2rem; color: var(--text); font-family: var(--font-secondary); font-weight: 600; font-size: 0.95rem; z-index: 100000; animation: notificationAppear 0.45s cubic-bezier(0.25, 1, 0.5, 1) forwards, notificationFade 0.45s ease-out 3.2s forwards; max-width:  800px; box-shadow: 0 7px 25px rgba(0,0,0,0.28), 0 0 12px rgba(var(--rgb-primary),0.08); text-align: center; }
        @keyframes notificationAppear { from { transform: translateX(-50%) translateY(115%) scale(0.85); opacity: 0; } to { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; } }
        @keyframes notificationFade { from { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); } to { opacity: 0; transform: translateX(-50%) translateY(-25px) scale(0.92); } }
        .notification.success { border-color: var(--success); color: var(--success); box-shadow: 0 0 18px rgba(var(--rgb-success), 0.35); } .notification.success::before { content: '✓ '; font-weight: bold; }
        .notification.error { border-color: var(--danger); color: var(--danger); box-shadow: 0 0 18px rgba(var(--rgb-danger), 0.35); } .notification.error::before { content: '✗ '; font-weight: bold; }
        .notification.info { border-color: var(--primary); color: var(--primary); box-shadow: 0 0 18px rgba(var(--rgb-primary), 0.35); } .notification.info::before { content: 'ℹ '; font-weight: bold; }

        .audio-controls { display: none; }
    </style>
</head>
<body class="theme-starlight-oracle">
    <div class="audio-controls">
        <audio id="backgroundMusic" loop><source src="musica.mp3" type="audio/mpeg"></audio>
    </div>
    <div class="bg-system">
        <div class="particle-field" id="particleField"></div>
        <div class="grid-overlay"></div>
        <div class="energy-waves"></div>
    </div>

    <div id="loginScreen" class="login-screen">
        <div class="login-container crystal-lens celestial-border">
            <h1 class="login-title celestial-glow">✨ ASTRA MYSTERIUM</h1>
            <p class="login-subtitle">Svela i Segreti degli Oracoli Celesti</p>
            <div id="loginForm" class="auth-form">
                <h3 style="color: var(--accent); margin-bottom: 2rem; font-family: var(--font-display);" class="celestial-glow">🗝️ ACCEDI AL PORTALE</h3>
                <div class="form-group"><input type="email" class="form-input" placeholder="📧 Email Astrale" id="loginEmail"></div>
                <div class="form-group"><input type="password" class="form-input" placeholder="🔑 Chiave Cosmica (Password)" id="loginPassword"></div>
                <button class="btn btn-primary btn-full" id="loginBtn"><span id="loginSpinner" class="spinner hidden"></span><span>🚀 ENTRA NEL COSMO</span></button>
                <div id="loginError" class="error-message hidden"></div>
                <div class="auth-toggle" id="showRegisterBtn">Nuovo Pellegrino Stellare? Registrati! 📜</div>
            </div>
            <div id="registerForm" class="auth-form hidden">
                <h3 style="color: var(--accent); margin-bottom: 2rem; font-family: var(--font-display);" class="celestial-glow">📜 ISCRIVITI ALL'ORDINE</h3>
                <div class="form-group"><input type="text" class="form-input" placeholder="👤 Nome Celestiale" id="registerName"></div>
                <div class="form-group"><input type="email" class="form-input" placeholder="📧 Email Astrale" id="registerEmail"></div>
                <div class="form-group"><input type="password" class="form-input" placeholder="🔑 Chiave Cosmica (Password)" id="registerPassword"></div>
                <div class="form-group"><input type="password" class="form-input" placeholder="🔑 Conferma Chiave" id="registerConfirm"></div>
                <button class="btn btn-primary btn-full" id="registerBtn"><span id="registerSpinner" class="spinner hidden"></span><span>✨ UNISCITI ALLE STELLE</span></button>
                <div id="registerError" class="error-message hidden"></div>
                <div id="registerSuccess" class="success-message hidden"></div>
                <div class="auth-toggle" id="showLoginBtn">Già un Oracolo? Accedi! 🗝️</div>
            </div>
            <div style="margin-top: 2.5rem; padding-top: 2.5rem; border-top: 1px solid rgba(var(--rgb-primary),0.2);">
                <button class="btn btn-secondary btn-full" id="guestBtn"><span>👤 VIAGGIA COME SPETTRO (Ospite)</span></button>
                <p style="font-size: 0.9rem; color: var(--text-dim); margin-top: 1rem; text-align: center; font-family: var(--font-secondary);">Modalità Spettro: i tuoi echi (progressi) non verranno registrati nel firmamento.</p>
            </div>
        </div>
    </div>

    <div id="gameWrapper" class="game-wrapper">
        <div id="userPanel" class="user-panel crystal-lens">
            <div id="userAvatar" class="user-avatar">A</div>
            <div>
                <div id="userName" style="font-weight: 700; color: var(--accent);" class="celestial-glow">Oracolo</div>
                <div id="userEmail" style="font-size: 0.9rem; color: var(--text-dim);">oracolo@astramysterium.com</div>
            </div>
            <button class="btn btn-secondary" id="logoutBtn" style="padding: 0.8rem 1.5rem; font-size:0.9em;">Disconnetti</button>
        </div>
        <div class="nav-bar">
            <div class="nav-btn" id="musicToggleBtn" title="Musica On/Off"><span id="musicIcon">🎵</span> <span id="musicStatus">OFF</span></div>
            <div class="nav-btn" id="settingsBtn" title="Impostazioni">⚙️ <span class="nav-text-mobile-hidden">Configura</span></div>
            <div class="nav-btn" onclick="window.location.href='index.html'" title="Arena Multiplayer">🌌 <span class="nav-text-mobile-hidden">Arena</span></div>
        </div>
        <div class="main-container">
            <header class="header">
                <h1 class="main-title celestial-glow">ASTRA MYSTERIUM</h1>
                <p class="subtitle">Decifra gli Enigmi delle Sfere Celesti!</p>
            </header>
            <div id="mainMenu">
                <div class="celestial-callout crystal-lens" id="dailyConstellation" title="La costellazione guida di oggi">
                    <div class="celestial-callout-title celestial-glow"><span id="dailyConstellationIcon">✨</span> Costellazione del Giorno: <span id="dailyConstellationName">Caricamento...</span></div>
                    <div class="celestial-callout-text" id="dailyConstellationBlessing">Il firmamento si prepara a svelare i suoi segreti...</div>
                </div>
                <div class="celestial-callout crystal-lens" id="dailyOracleBtn" title="Scopri il tuo presagio!">
                    <div class="celestial-callout-title celestial-glow">🔮 Oracolo del Giorno 🔮</div>
                    <div class="celestial-callout-text" id="dailyOracleText">"Le stelle sussurrano... clicca per ascoltare."</div>
                </div>
                <div class="games-grid">
                    <div class="game-card crystal-lens" data-game="numberQuest"><div class="game-card-background"></div><div class="game-card-content"><div class="game-icon">🔢</div><div class="game-title celestial-glow">Numerologia Astrale</div><div class="game-description">Decifra la sequenza numerica sacra attraverso 10 prove cosmiche.</div></div></div>
                    <div class="game-card crystal-lens" data-game="memoryChallenge"><div class="game-card-background" style="background-image: url('https://www.transparenttextures.com/patterns/inspiration-geometry.png'), linear-gradient(to bottom, rgba(var(--rgb-accent),0.1), rgba(var(--rgb-secondary),0.15));"></div><div class="game-card-content"><div class="game-icon">🧠</div><div class="game-title celestial-glow">Memoria Stellare</div><div class="game-description">Ricorda e abbina i glifi celesti nascosti nelle costellazioni.</div></div></div>
                    <div class="game-card crystal-lens" data-game="astralSequence"><div class="game-card-background" style="background-image: url('https://www.transparenttextures.com/patterns/diamond-upholstery.png'), linear-gradient(to bottom, rgba(var(--rgb-primary),0.15), rgba(var(--rgb-accent),0.1));"></div><div class="game-card-content"><div class="game-icon">✨</div><div class="game-title celestial-glow">Sequenza Astrale</div><div class="game-description">Osserva la danza delle stelle e ripeti la loro mistica coreografia. (In sviluppo)</div></div></div>
                    <div class="game-card crystal-lens" data-game="reactionTime"><div class="game-card-background" style="background-image: url('https://www.transparenttextures.com/patterns/fancy-lines.png'), linear-gradient(to bottom, rgba(var(--rgb-danger),0.1), rgba(var(--rgb-warning),0.1));"></div><div class="game-card-content"><div class="game-icon">☄️</div><div class="game-title celestial-glow">Cometa Fulminea</div><div class="game-description">Reagisci alla velocità della luce cosmica per catturare le stelle cadenti.</div></div></div>
                    <div class="game-card crystal-lens" data-game="runeEnigma"><div class="game-card-background" style="background-image: url('https://www.transparenttextures.com/patterns/lined-paper.png'), linear-gradient(to bottom, rgba(var(--rgb-secondary),0.2), rgba(var(--rgb-dark),0.3));"></div><div class="game-card-content"><div class="game-icon">📜</div><div class="game-title celestial-glow">Enigma delle Rune</div><div class="game-description">Interpreta antichi simboli e svela i misteri celati nelle pergamene astrali. (In sviluppo)</div></div></div>
                    <div class="game-card crystal-lens" data-game="colorMatch"><div class="game-card-background" style="background-image: url('https://www.transparenttextures.com/patterns/aurora.png'), linear-gradient(to bottom, rgba(var(--rgb-success),0.1), rgba(var(--rgb-primary),0.15));"></div><div class="game-card-content"><div class="game-icon">🌈</div><div class="game-title celestial-glow">Armonia Cromatica</div><div class="game-description">Allinea i colori delle nebulose prima che il tempo cosmico si esaurisca.</div></div></div>
                </div>
                <!-- Bottone per andare a BU -->
<div class="text-center" style="margin-bottom: 2rem;">
    <button onclick="location.href='hjkj.html'" class="btn btn-primary">Vai a ULTIMATE BOSS RUSH</button>
</div>

<div class="stats-panel crystal-lens celestial-border">
    ...
</div>
                <div class="stats-panel crystal-lens celestial-border">
                    <h3 class="stats-title celestial-glow">🌠 Cronache Celesti 🌠</h3>
                    <div class="stats-grid">
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="totalGames">0</div><div class="stat-label">Profezie Tentate</div></div>
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="totalWins">0</div><div class="stat-label">Destini Svelati</div></div>
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="bestScore">0</div><div class="stat-label">Eco Supremo</div></div>
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="winRate">0%</div><div class="stat-label">Allineamento Astrale</div></div>
                    </div>
                </div>
            </div>
            <div id="numberQuest" class="hidden">
                <div class="game-interface crystal-lens celestial-border">
                    <div class="game-header"><h2 class="game-title-main celestial-glow">🔢 Numerologia Astrale</h2><p>Scegli il tuo Percorso attraverso 10 Sfere Celesti</p></div>
                    <div class="difficulty-selector">
                        <div class="difficulty-btn difficulty-easy active" data-difficulty="easy">NOVIZIO<br><small>Sfere 0-30 → 0-300<br>10 Congiunzioni</small></div>
                        <div class="difficulty-btn difficulty-normal" data-difficulty="normal">ADEPTA<br><small>Sfere 0-80 → 0-800<br>7 Congiunzioni</small></div>
                        <div class="difficulty-btn difficulty-hard" data-difficulty="hard">MAESTRA<br><small>Sfere 0-150 → 0-1500<br>5 Cong. / Timer Arcano</small></div>
                    </div>
                    <div class="text-center"><button class="btn btn-primary" id="startNumberQuestBtn"><span>✨ INIZIA IL RITUALE</span></button><button class="btn btn-secondary" id="backToMenuBtn"><span>🌌 TORNA AL FIRMAMENTO</span></button></div>
                </div>
                <div id="levelProgress" class="progress-container crystal-lens celestial-border hidden">
                    <h3 class="celestial-glow">🌌 Progresso Cosmico 🌌</h3>
                    <div style="display: flex; justify-content: space-between; margin: 1rem 0; font-weight: 600; font-family: var(--font-secondary);"><span>Sfera <span id="currentLevel" style="color: var(--accent);">1</span>/10</span><span id="levelRange" style="color: var(--primary);">Eco: 0-30</span></div>
                    <div class="progress-bar"><div class="progress-fill" id="levelFill" style="width: 10%;"></div></div>
                    <div id="timerDisplay" class="timer-display hidden">40</div>
                </div>
                <div id="numberGameArea" class="hidden">
                    <div class="stats-grid mb-2">
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="currentNumber">?</div><div class="stat-label">Numero Arcano</div></div>
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="attemptsLeft">10</div><div class="stat-label">Congiunzioni Rimaste</div></div>
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="currentScore">0</div><div class="stat-label">Armonia Totale</div></div>
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="levelScore">0</div><div class="stat-label">Armonia Sfera</div></div>
                    </div>
                    <div class="game-area">
                        <div class="control-panel crystal-lens celestial-border"><h3 class="text-center celestial-glow" style="margin-bottom: 2rem; font-family: var(--font-display);">🔮 Altare della Divinazione</h3><input type="number" id="guessInput" class="game-input" placeholder="Sussurra un Numero" min="0"><button id="submitGuess" class="btn btn-primary btn-full"><span>✨ SVELA!</span></button><div id="hint" class="hint-display">Il cosmo attende la tua intuizione...</div></div>
                        <div class="history-panel crystal-lens celestial-border"><h3 class="text-center celestial-glow" style="margin-bottom: 2rem; font-family: var(--font-display);">📜 Cronache dei Tentativi</h3><div id="history" style="max-height: 400px; overflow-y: auto;"></div></div>
                    </div>
                    <div class="text-center" style="margin-top:2rem;"><button class="btn btn-secondary" id="resetNumberQuestBtn" style="margin-right:1rem;"><span>🔄 Riavvia Sfera</span></button><button class="btn btn-secondary" id="backToMenuFromGameBtn"><span>🌌 Torna al Firmamento</span></button></div>
                </div>
            </div>
            <div id="astralSequence" class="hidden"><div class="game-interface crystal-lens celestial-border"><div class="game-header"><h2 class="game-title-main celestial-glow">✨ Sequenza Astrale</h2><p>Le costellazioni danzano, riuscirai a seguire il loro ritmo?</p></div><div class="text-center" style="padding: 3rem; font-size: 1.2rem; color: var(--text-dim); font-family: var(--font-secondary);"><p>🌌 Questo portale astrale è ancora in fase di allineamento... 🌌</p><p>Torna quando le stelle saranno propizie!</p></div><div class="text-center"><button class="btn btn-secondary" onclick="showMainMenu()"><span>🌌 Torna al Firmamento</span></button></div></div></div>
            <div id="runeEnigma" class="hidden"><div class="game-interface crystal-lens celestial-border"><div class="game-header"><h2 class="game-title-main celestial-glow">📜 Enigma delle Rune</h2><p>Antichi simboli attendono la tua interpretazione.</p></div><div class="text-center" style="padding: 3rem; font-size: 1.2rem; color: var(--text-dim); font-family: var(--font-secondary);"><p>📜 Le pergamene runiche sono ancora sigillate dal tempo... 📜</p><p>La loro saggezza verrà svelata prossimamente!</p></div><div class="text-center"><button class="btn btn-secondary" onclick="showMainMenu()"><span>🌌 Torna al Firmamento</span></button></div></div></div>
            <div id="memoryChallenge" class="hidden">
                <div class="game-interface crystal-lens celestial-border">
                    <div class="game-header"><h2 class="game-title-main celestial-glow">🧠 Memoria Stellare</h2><p>Abbina i glifi celesti prima che svaniscano nel cosmo.</p></div>
                    <div class="stats-grid mb-2">
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="memoryLevel">1</div><div class="stat-label">Costellazione</div></div>
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="memoryPairs">0</div><div class="stat-label">Glifi Svelati</div></div>
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="memoryMoves">0</div><div class="stat-label">Intuizioni</div></div>
                        <div class="stat-card crystal-lens"><div class="stat-value celestial-glow" id="memoryTime">0</div><div class="stat-label">Tempo Astrale</div></div>
                    </div>
                    <div class="memory-grid" id="memoryGrid"></div>
                    <div class="text-center" style="margin-top:2rem;"><button class="btn btn-primary" id="startMemoryBtn" style="margin-right:1rem;"><span>✨ INIZIA DIVINAZIONE</span></button><button class="btn btn-secondary" id="backToMenuFromMemoryBtn"><span>🌌 Torna al Firmamento</span></button></div>
                </div>
            </div>
            <div id="settings" class="hidden">
                <div class="game-interface crystal-lens celestial-border">
                    <div class="game-header"><h2 class="game-title-main celestial-glow">⚙️ Tomo delle Configurazioni Cosmiche</h2></div>
                    <div class="settings-grid">
                        <div class="setting-group crystal-lens"><div class="setting-title celestial-glow">🎶 Armonie Celesti</div><div style="margin: 1rem 0;"><label style="display: block; margin-bottom: 0.5rem; font-family: var(--font-secondary);">Volume Musica Cosmica:</label><input type="range" class="slider" id="musicVolume" min="0" max="100" value="50"><div class="text-center" style="margin-top: 0.5rem; font-family: var(--font-secondary);"><span id="volumeDisplay">50%</span></div></div><button class="btn btn-primary btn-full" id="musicControlBtn"><span id="musicToggle">🔊 Attiva Melodie</span></button></div>
                        <div class="setting-group crystal-lens"><div class="setting-title celestial-glow">🎨 Visioni Astrali (Temi)</div><div class="theme-grid">
                            <div class="theme-option theme-starlight-oracle active" data-theme="starlight-oracle" title="Oracolo Stellare"><div class="theme-icon">🌟</div><div class="theme-name">Stellare</div></div>
                            <div class="theme-option theme-nebula-dream" data-theme="nebula-dream" title="Sogno Nebulare"><div class="theme-icon">🔮</div><div class="theme-name">Nebula</div></div>
                            <div class="theme-option theme-lunar-sanctum" data-theme="lunar-sanctum" title="Santuario Lunare"><div class="theme-icon">🌙</div><div class="theme-name">Lunare</div></div>
                            <div class="theme-option theme-sunstone-prophecy" data-theme="sunstone-prophecy" title="Profezia Solare"><div class="theme-icon">☀️</div><div class="theme-name">Solare</div></div>
                            <div class="theme-option theme-void-weaver" data-theme="void-weaver" title="Tessitore del Vuoto"><div class="theme-icon">🌌</div><div class="theme-name">Vuoto</div></div>
                            <div class="theme-option theme-astral-garden" data-theme="astral-garden" title="Giardino Astrale"><div class="theme-icon">🌿</div><div class="theme-name">Giardino</div></div>
                            <div class="theme-option theme-ancient-relic" data-theme="ancient-relic" title="Reliquia Antica"><div class="theme-icon">⏳</div><div class="theme-name">Reliquia</div></div>
                        </div><div class="text-center" style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-dim); font-family: var(--font-secondary);">Scegli la Tua Visione del Cosmo</div></div>
                        <div class="setting-group crystal-lens"><div class="setting-title celestial-glow">📜 Archivio Arcano</div><button class="btn btn-secondary btn-full" id="resetStatsBtn"><span>🗑️ Cancella Cronache</span></button><button class="btn btn-secondary btn-full" id="exportStatsBtn"><span>📤 Trascrivi Echi (Esporta)</span></button><button class="btn btn-secondary btn-full" id="creditsBtn"><span>ℹ️ Custodi del Sapere (Crediti)</span></button></div>
                        <div class="setting-group crystal-lens"><div class="setting-title celestial-glow">⚡ Flusso Energetico (Prestazioni)</div><label style="display: flex; align-items: center; margin: 1.5rem 0; cursor:pointer;"><input type="checkbox" id="reduceAnimations" style="margin-right: 1rem; width:18px; height:18px; accent-color: var(--primary);">Attenua Flussi Astrali (Animazioni)</label><label style="display: flex; align-items: center; margin: 1.5rem 0; cursor:pointer;"><input type="checkbox" id="reduceParticles" style="margin-right: 1rem; width:18px; height:18px; accent-color: var(--primary);">Dirada Polvere di Stelle (Particelle)</label></div>
                    </div>
                    <div class="text-center mt-2" style="margin-top:3rem;"><button class="btn btn-primary" id="backToMenuFromSettingsBtn"><span>🌌 Torna al Firmamento</span></button></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State, Settings, THEME_DETAILS, Difficulties, dailyOracleMessages (invariati)
        let currentUser = null;
        let isLoggedIn = false;
        let backgroundMusic = null;
        let gameState = { /* ... come prima ... */ 
            currentGame: null,
            numberQuest: { secretNumber: 0, attemptsLeft: 10, maxAttempts: 10, score: 0, levelScore: 0, difficulty: 'easy', currentLevel: 1, gameStarted: false, history: [], timer: null, timeLeft: 40 },
            memoryGame: { level: 1, pairsFound: 0, moves: 0, time: 0, cards: [], flippedCardsElements: [], matchedPairs: 0, timer: null, gridSize: 4 }
        };
        let settings = { musicEnabled: false, musicVolume: 50, theme: 'starlight-oracle', reduceAnimations: false, reduceParticles: false };
        const THEME_DETAILS = { /* ... come prima ... */ 
            'starlight-oracle': { name: 'Oracolo Stellare', icon: '🌟', colors: { primary: '#7DF9FF', secondary: '#B57EDC', accent: '#FFD700' } },
            'nebula-dream': { name: 'Sogno Nebulare', icon: '🔮', colors: { primary: '#DA70D6', secondary: '#8A2BE2', accent: '#AFEEEE' } },
            'lunar-sanctum': { name: 'Santuario Lunare', icon: '🌙', colors: { primary: '#C0C0C0', secondary: '#778899', accent: '#ADD8E6' } },
            'sunstone-prophecy': { name: 'Profezia Solare', icon: '☀️', colors: { primary: '#FFD700', secondary: '#FF8C00', accent: '#FFFACD' } },
            'void-weaver': { name: 'Tessitore del Vuoto', icon: '🌌', colors: { primary: '#483D8B', secondary: '#800080', accent: '#E6E6FA' } },
            'astral-garden': { name: 'Giardino Astrale', icon: '🌿', colors: { primary: '#2E8B57', secondary: '#4682B4', accent: '#FFFAF0' } },
            'ancient-relic': { name: 'Reliquia Antica', icon: '⏳', colors: { primary: '#DAA520', secondary: '#8B4513', accent: '#F5DEB3' } }
        };
        const numberQuestDifficulties = { /* ... come prima ... */ 
            easy: { name: 'NOVIZIO', levels: [ { min: 0, max: 30 }, { min: 0, max: 60 }, { min: 0, max: 90 }, { min: 0, max: 120 }, { min: 0, max: 150 }, { min: 0, max: 180 }, { min: 0, max: 210 }, { min: 0, max: 240 }, { min: 0, max: 270 }, { min: 0, max: 300 } ], attempts: 10, hasTimer: false },
            normal: { name: 'ADEPTA', levels: [ { min: 0, max: 80 }, { min: 0, max: 160 }, { min: 0, max: 240 }, { min: 0, max: 320 }, { min: 0, max: 400 }, { min: 0, max: 480 }, { min: 0, max: 560 }, { min: 0, max: 640 }, { min: 0, max: 720 }, { min: 0, max: 800 } ], attempts: 7, hasTimer: false },
            hard: { name: 'MAESTRA', levels: [ { min: 0, max: 150 }, { min: 0, max: 300 }, { min: 0, max: 450 }, { min: 0, max: 600 }, { min: 0, max: 750 }, { min: 0, max: 900 }, { min: 0, max: 1050 }, { min: 0, max: 1200 }, { min: 0, max: 1350 }, { min: 0, max: 1500 } ], attempts: 5, hasTimer: true, timeLimit: 40 }
        };
        const dailyOracleMessages = [ /* ... come prima ... */ 
            "Le stelle prevedono una sfida imminente. Sii pronto!", "Un'eco di saggezza risuona nel cosmo. Ascolta attentamente.", "La fortuna favorisce gli audaci. Oggi è il giorno per osare.", "Una nuova costellazione si forma, portando con sé opportunità.", "Rifletti sui misteri passati per svelare il futuro.", "L'energia cosmica è forte oggi. Canalizzala nei tuoi giochi.", "Un piccolo enigma attende la tua intuizione. Cerca i segni."
        ];
        
        const constellations = [
            { name: "Drago Celeste", icon: "🐉", blessings: ["La forza del Drago ti accompagna. Affronta le sfide con coraggio!", "L'antica saggezza del Drago illumina il tuo cammino.", "Senti il fuoco del Drago? È un giorno di grande energia!"] },
            { name: "Fenice Astrale", icon: "🔥", blessings: ["Dalle ceneri del dubbio, rinasce la tua intuizione.", "La Fenice ti dona speranza e rinnovamento.", "Oggi, ogni fine è un nuovo inizio."] },
            { name: "Lupo Stellare", icon: "🐺", blessings: ["Fidati del tuo istinto, come il Lupo segue la luna.", "La lealtà delle stelle ti protegge.", "Ascolta il richiamo selvaggio del cosmo."] },
            { name: "Serpente Cosmico", icon: "🐍", blessings: ["La trasformazione è vicina. Abbraccia il cambiamento.", "La conoscenza segreta si svela a chi sa osservare.", "Come il Serpente, sii flessibile e astuto."] },
            { name: "Gufo Oracolare", icon: "🦉", blessings: ["La saggezza ti guida nelle tenebre. Vedi oltre l'illusione.", "Un messaggio importante ti attende. Apri la mente.", "La notte porta consiglio e chiarezza."] }
        ];


        document.addEventListener('DOMContentLoaded', function() {
            initializeAudio();
            loadSettings();
            createAdvancedBackground(); // Chiamata dopo loadSettings
            checkLoginStatus();
            setupEventListeners();
            applySettingsToDOM();
            setupDailyOracle();
            setupDailyConstellation(); // NUOVA FUNZIONE
        });

        function initializeAudio() { /* ... come prima ... */ 
            backgroundMusic = document.getElementById('backgroundMusic');
            if (backgroundMusic) { backgroundMusic.volume = settings.musicVolume / 100; }
        }
        
        function setupDailyOracle() { /* ... come prima ... */ 
            const oracleBtn = document.getElementById('dailyOracleBtn');
            const oracleTextEl = document.getElementById('dailyOracleText');
            if (oracleBtn && oracleTextEl) {
                oracleBtn.addEventListener('click', () => {
                    const randomIndex = Math.floor(Math.random() * dailyOracleMessages.length);
                    oracleTextEl.textContent = dailyOracleMessages[randomIndex];
                    showNotification("🔮 Presagio Svelato!", "info");
                     if (typeof confetti !== 'undefined' && !settings.reduceAnimations) {
                        const themeConfettiColors = (THEME_DETAILS[settings.theme] || THEME_DETAILS['starlight-oracle']).colors;
                        confetti({ particleCount: 50, spread: 70, origin: { y: 0.6 }, colors: [themeConfettiColors.primary, themeConfettiColors.accent, '#FFFFFF'] });
                    }
                });
            }
        }

        function setupDailyConstellation() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const constellationIndex = dayOfYear % constellations.length;
            const activeConstellation = constellations[constellationIndex];
            const blessingIndex = dayOfYear % activeConstellation.blessings.length;
            const activeBlessing = activeConstellation.blessings[blessingIndex];

            document.getElementById('dailyConstellationIcon').textContent = activeConstellation.icon;
            document.getElementById('dailyConstellationName').textContent = activeConstellation.name;
            document.getElementById('dailyConstellationBlessing').textContent = activeBlessing;
        }


        function setupEventListeners() { /* ... come prima, assicurati che gli ID siano corretti ... */ 
            document.getElementById('loginBtn')?.addEventListener('click', loginUser);
            document.getElementById('registerBtn')?.addEventListener('click', registerUser);
            document.getElementById('guestBtn')?.addEventListener('click', loginAsGuest);
            document.getElementById('showRegisterBtn')?.addEventListener('click', showRegisterForm);
            document.getElementById('showLoginBtn')?.addEventListener('click', showLoginForm);
            document.getElementById('logoutBtn')?.addEventListener('click', logout);
            document.getElementById('musicToggleBtn')?.addEventListener('click', toggleMusic);
            document.getElementById('settingsBtn')?.addEventListener('click', showSettings);
            document.querySelectorAll('.game-card[data-game]').forEach(card => {
                card.addEventListener('click', function() {
                    const gameMode = this.getAttribute('data-game');
                    if (gameMode === "astralSequence" || gameMode === "runeEnigma") {
                        showNotification("✨ Questo portale è in fase di allineamento. Torna presto!", "info");
                    }
                    showGameMode(gameMode);
                });
            });
            document.getElementById('backToMenuBtn')?.addEventListener('click', showMainMenu);
            document.getElementById('backToMenuFromGameBtn')?.addEventListener('click', showMainMenu);
            document.getElementById('backToMenuFromMemoryBtn')?.addEventListener('click', showMainMenu);
            document.getElementById('backToMenuFromSettingsBtn')?.addEventListener('click', showMainMenu);
            document.querySelector('#astralSequence .btn-secondary')?.addEventListener('click', showMainMenu);
            document.querySelector('#runeEnigma .btn-secondary')?.addEventListener('click', showMainMenu);
            document.querySelectorAll('.difficulty-btn').forEach(btn => { btn.addEventListener('click', function() { selectDifficulty(this.getAttribute('data-difficulty')); }); });
            document.getElementById('startNumberQuestBtn')?.addEventListener('click', startNumberQuest);
            document.getElementById('submitGuess')?.addEventListener('click', makeGuess);
            document.getElementById('resetNumberQuestBtn')?.addEventListener('click', resetNumberQuest);
            document.getElementById('startMemoryBtn')?.addEventListener('click', startMemoryGame);
            document.getElementById('musicVolume')?.addEventListener('input', function() { setMusicVolume(this.value); });
            document.getElementById('musicControlBtn')?.addEventListener('click', toggleMusic);
            document.getElementById('resetStatsBtn')?.addEventListener('click', resetAllStats);
            document.getElementById('exportStatsBtn')?.addEventListener('click', exportStats);
            document.getElementById('creditsBtn')?.addEventListener('click', showCredits);
            document.getElementById('reduceAnimations')?.addEventListener('change', function() { toggleAnimations(this.checked); });
            document.getElementById('reduceParticles')?.addEventListener('change', function() { toggleParticles(this.checked); });
            document.querySelectorAll('.theme-option').forEach(option => { option.addEventListener('click', function() { setTheme(this.getAttribute('data-theme')); }); });
            document.addEventListener('keydown', function(e) { if (e.key === 'Enter') { const activeEl = document.activeElement; if (!activeEl) return; if (activeEl.id === 'guessInput') { e.preventDefault(); makeGuess(); } else if (activeEl.id === 'loginEmail' || activeEl.id === 'loginPassword') { e.preventDefault(); loginUser(); } else if (activeEl.id === 'registerName' || activeEl.id === 'registerEmail' || activeEl.id === 'registerPassword' || activeEl.id === 'registerConfirm') { e.preventDefault(); registerUser(); } } });
        }

        function createAdvancedBackground() { /* ... come prima, ma usa settings.reduceParticles ... */ 
            const particleField = document.getElementById('particleField');
            if (!particleField) return;
            const numParticles = settings.reduceParticles ? 6 : 15; // Ridotto ulteriormente
            particleField.innerHTML = '';
            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                const size = Math.random() * 2.2 + 0.8; // Stelle leggermente più piccole
                particle.style.width = size + 'px'; particle.style.height = size + 'px';
                particle.style.setProperty('--y-end', (Math.random() * 30 - 15) + 'px'); // Movimento ridotto
                particle.style.setProperty('--x-end', (Math.random() * 30 - 15) + 'px');
                particle.style.setProperty('--o-start', (Math.random() * 0.3 + 0.1).toFixed(2));
                particle.style.setProperty('--o-mid', (Math.random() * 0.4 + 0.4).toFixed(2)); // Opacità media ridotta
                particle.style.animationDelay = Math.random() * 12 + 's'; // Delay aumentato
                particle.style.animationDuration = (Math.random() * 12 + 10) + 's'; // Durata aumentata
                particleField.appendChild(particle);
            }
        }
        
        function getRGBValues(hexColor) { /* ... come prima ... */ 
            if (!hexColor || typeof hexColor !== 'string' || hexColor.charAt(0) !== '#') { return '0,0,0'; }
            const r = parseInt(hexColor.slice(1, 3), 16); const g = parseInt(hexColor.slice(3, 5), 16); const b = parseInt(hexColor.slice(5, 7), 16);
            return `${r},${g},${b}`;
        }

        function toggleMusic() { /* ... come prima ... */ 
            settings.musicEnabled = !settings.musicEnabled;
            const musicIconEl = document.getElementById('musicIcon');
            if (settings.musicEnabled && backgroundMusic) {
                backgroundMusic.play().catch(e => { console.error("Errore riproduzione musica:", e); settings.musicEnabled = false; });
                if (musicIconEl) musicIconEl.textContent = '🎶';
                showNotification('🎶 Melodie Celesti Attivate!', 'success');
            } else if (backgroundMusic) {
                backgroundMusic.pause();
                if (musicIconEl) musicIconEl.textContent = '🔇';
                showNotification('🔇 Silenzio Cosmico.', 'info');
            }
            updateMusicStatus(); saveSettings();
        }
        function updateMusicStatus() { /* ... come prima ... */ 
            const statusEl = document.getElementById('musicStatus'); const toggleEl = document.getElementById('musicToggle'); const musicIconEl = document.getElementById('musicIcon');
            if (settings.musicEnabled) { if (statusEl) statusEl.textContent = 'ON'; if (toggleEl) toggleEl.innerHTML = '🔇 Disattiva Melodie'; if (musicIconEl) musicIconEl.textContent = '🎶'; }
            else { if (statusEl) statusEl.textContent = 'OFF'; if (toggleEl) toggleEl.innerHTML = '🔊 Attiva Melodie'; if (musicIconEl) musicIconEl.textContent = '🔇'; }
        }
        function setMusicVolume(volume) { /* ... come prima ... */ 
            settings.musicVolume = parseInt(volume); document.getElementById('volumeDisplay').textContent = settings.musicVolume + '%';
            if (backgroundMusic) backgroundMusic.volume = settings.musicVolume / 100; saveSettings();
        }
        function showNotification(message, type = 'info') { /* ... come prima ... */ 
            const existingNotification = document.querySelector('.notification'); if (existingNotification) existingNotification.remove();
            const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { if (document.body.contains(notification)) { document.body.removeChild(notification); } }, 3500);
        }

        // Funzioni Auth (checkLoginStatus, showLoginScreen, showGameHub, ecc.) - invariate
        function checkLoginStatus() { const savedUser = localStorage.getItem('astramysterium-user'); if (savedUser) { currentUser = JSON.parse(savedUser); isLoggedIn = true; showGameHub(); } else { showLoginScreen(); } }
        function showLoginScreen() { document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('gameWrapper').classList.remove('active'); }
        function showGameHub() { document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('gameWrapper').classList.add('active'); document.getElementById('userPanel').classList.add('active'); updateUserInfo(); loadStats(); }
        function showLoginForm() { document.getElementById('loginForm').classList.remove('hidden'); document.getElementById('registerForm').classList.add('hidden'); clearErrors(); }
        function showRegisterForm() { document.getElementById('registerForm').classList.remove('hidden'); document.getElementById('loginForm').classList.add('hidden'); clearErrors(); }
        function clearErrors() { ['loginError', 'registerError', 'registerSuccess'].forEach(id => { const el = document.getElementById(id); if (el) el.classList.add('hidden'); }); }
        function showError(id, msg) { const el=document.getElementById(id); if(el){el.textContent=msg; el.classList.remove('hidden');}}
        function showSuccess(id, msg) { const el=document.getElementById(id); if(el){el.textContent=msg; el.classList.remove('hidden');}}
        function validateEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
        function registerUser() { clearErrors(); const name = document.getElementById('registerName').value.trim(); const email = document.getElementById('registerEmail').value.trim(); const password = document.getElementById('registerPassword').value; const confirm = document.getElementById('registerConfirm').value; if (!name) return showError('registerError', '❌ Inserisci il tuo Nome Celestiale!'); if (!email || !validateEmail(email)) return showError('registerError', '❌ Email Astrale non valida!'); if (!password || password.length < 6) return showError('registerError', '❌ Chiave Cosmica troppo debole (min 6 caratteri)!'); if (password !== confirm) return showError('registerError', '❌ Le Chiavi Cosmiche non coincidono!'); const users = JSON.parse(localStorage.getItem('astramysterium-users') || '{}'); if (users[email]) return showError('registerError', '❌ Email già consacrata alle stelle! Accedi.'); document.getElementById('registerSpinner').classList.remove('hidden'); setTimeout(() => { users[email] = { name, email, password, registeredAt: new Date().toISOString() }; localStorage.setItem('astramysterium-users', JSON.stringify(users)); document.getElementById('registerSpinner').classList.add('hidden'); showSuccess('registerSuccess', '✅ Consacrazione completata! Ora puoi accedere al portale.'); ['registerName', 'registerEmail', 'registerPassword', 'registerConfirm'].forEach(id => document.getElementById(id).value = ''); setTimeout(() => { showLoginForm(); document.getElementById('loginEmail').value = email; }, 2000); }, 800); }
        function loginUser() { clearErrors(); const email = document.getElementById('loginEmail').value.trim(); const password = document.getElementById('loginPassword').value; if (!email || !password) return showError('loginError', '❌ Inserisci Email e Chiave Cosmica!'); document.getElementById('loginSpinner').classList.remove('hidden'); setTimeout(() => { const users = JSON.parse(localStorage.getItem('astramysterium-users') || '{}'); const userData = users[email]; document.getElementById('loginSpinner').classList.add('hidden'); if (!userData) return showError('loginError', '❌ Email non riconosciuta dalle stelle! Registrati.'); if (userData.password !== password) return showError('loginError', '❌ Chiave Cosmica errata!'); currentUser = { name: userData.name, email: userData.email, provider: 'Email' }; isLoggedIn = true; localStorage.setItem('astramysterium-user', JSON.stringify(currentUser)); if (typeof confetti !== 'undefined' && !settings.reduceAnimations) { const themeConfettiColors = (THEME_DETAILS[settings.theme] || THEME_DETAILS['starlight-oracle']).colors; confetti({ particleCount: 120, spread: 80, origin: { y: 0.55 }, angle: Math.random() * 90 + 45, colors: [themeConfettiColors.primary, themeConfettiColors.secondary, themeConfettiColors.accent, '#FFFFFF'] }); } showNotification(`✨ Benvenuto, Oracolo ${currentUser.name}!`, 'success'); setTimeout(showGameHub, 800); }, 600); }
        function loginAsGuest() { currentUser = { name: 'Pellegrino Spettrale', email: 'guest@astramysterium.com', provider: 'Guest' }; isLoggedIn = true; localStorage.setItem('astramysterium-user', JSON.stringify(currentUser)); showNotification('👤 Viaggio come Spettro iniziato.', 'info'); showGameHub(); }
        function logout() { if (confirm('Sei sicuro di voler abbandonare questa corrente astrale (logout)?')) { currentUser = null; isLoggedIn = false; localStorage.removeItem('astramysterium-user'); if (backgroundMusic && settings.musicEnabled) { backgroundMusic.pause(); settings.musicEnabled = false; updateMusicStatus(); } showNotification('👋 A presto, viaggiatore astrale.', 'info'); showLoginScreen(); } }
        function updateUserInfo() { if (currentUser) { document.getElementById('userName').textContent = currentUser.name; document.getElementById('userEmail').textContent = currentUser.email; document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase(); } }
        
        // Settings Functions
        function loadSettings() { const saved = localStorage.getItem('astramysterium-settings'); if (saved) settings = { ...settings, ...JSON.parse(saved) }; }
        function saveSettings() { localStorage.setItem('astramysterium-settings', JSON.stringify(settings)); }
        function applySettingsToDOM() {
            document.body.className = `theme-${settings.theme}`;
            document.body.classList.toggle('animations-reduced', settings.reduceAnimations); // Applica classe per animazioni ridotte
            const currentThemeDetail = THEME_DETAILS[settings.theme] || THEME_DETAILS['starlight-oracle'];
            if (currentThemeDetail && currentThemeDetail.colors) {
                document.documentElement.style.setProperty('--rgb-primary', getRGBValues(currentThemeDetail.colors.primary));
                document.documentElement.style.setProperty('--rgb-secondary', getRGBValues(currentThemeDetail.colors.secondary));
                document.documentElement.style.setProperty('--rgb-accent', getRGBValues(currentThemeDetail.colors.accent));
            }
            document.getElementById('musicVolume').value = settings.musicVolume;
            document.getElementById('volumeDisplay').textContent = settings.musicVolume + '%';
            document.getElementById('reduceAnimations').checked = settings.reduceAnimations;
            document.getElementById('reduceParticles').checked = settings.reduceParticles;
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
            const activeOpt = document.querySelector(`.theme-option[data-theme="${settings.theme}"]`);
            if (activeOpt) activeOpt.classList.add('active');
            updateMusicStatus();
            if (backgroundMusic) backgroundMusic.volume = settings.musicVolume / 100;
            if(!settings.reduceParticles) createAdvancedBackground(); else document.getElementById('particleField').innerHTML = '';
        }
        function setTheme(themeKey) { settings.theme = themeKey; applySettingsToDOM(); saveSettings(); const themeName = (THEME_DETAILS[themeKey] || {}).name || themeKey; showNotification(`🎨 Visione cambiata in: ${themeName}`, 'success'); }
        function toggleAnimations(reduce) { settings.reduceAnimations = reduce; document.body.classList.toggle('animations-reduced', reduce); saveSettings(); showNotification(`⚡ Flussi Astrali ${reduce ? 'attenuati' : 'ripristinati'}`, 'info'); }
        function toggleParticles(reduce) { settings.reduceParticles = reduce; if(!reduce) createAdvancedBackground(); else document.getElementById('particleField').innerHTML = ''; saveSettings(); showNotification(`✨ Polvere di Stelle ${reduce ? 'diradata' : 'intensificata'}`, 'info'); }

        // Stats Functions (loadStats, saveStats, resetAllStats, exportStats, showCredits) - invariate
        function loadStats() { if (!isLoggedIn || !currentUser) return; const key = `astramysterium-${currentUser.email}`; ['totalGames', 'totalWins', 'bestScore'].forEach(stat => { document.getElementById(stat).textContent = localStorage.getItem(`${key}-${stat}`) || 0; }); const tg = parseInt(document.getElementById('totalGames').textContent); const tw = parseInt(document.getElementById('totalWins').textContent); document.getElementById('winRate').textContent = (tg > 0 ? Math.round((tw / tg) * 100) : 0) + '%'; }
        function saveStats(gameWon = false, score = 0) { if (!isLoggedIn || !currentUser) return; const key = `astramysterium-${currentUser.email}`; const statsToUpdate = { 'totalGames': (parseInt(localStorage.getItem(`${key}-totalGames`) || 0)) + 1, 'totalWins': (parseInt(localStorage.getItem(`${key}-totalWins`) || 0)) + (gameWon ? 1 : 0), 'bestScore': Math.max(parseInt(localStorage.getItem(`${key}-bestScore`) || 0), score) }; for (const stat in statsToUpdate) { localStorage.setItem(`${key}-${stat}`, statsToUpdate[stat]); } loadStats(); }
        function resetAllStats() { if (confirm('Sei sicuro di voler cancellare le tue Cronache Celesti? Questo atto è definitivo!')) { if (isLoggedIn && currentUser) { const key = `astramysterium-${currentUser.email}`; ['totalGames', 'totalWins', 'bestScore'].forEach(stat => localStorage.removeItem(`${key}-${stat}`)); } loadStats(); showNotification('🗑️ Cronache Celesti azzerate.', 'success'); } }
        function exportStats() { if (!isLoggedIn || !currentUser) return showNotification('❌ Devi essere connesso al flusso astrale per trascrivere!', 'error'); const key = `astramysterium-${currentUser.email}`; const data = { user: currentUser, settings, totalGames: localStorage.getItem(`${key}-totalGames`) || 0, totalWins: localStorage.getItem(`${key}-totalWins`) || 0, bestScore: localStorage.getItem(`${key}-totalWins`) || 0, }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `astramysterium-echi-${currentUser.name.replace(/\s+/g, '_')}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); showNotification('📤 Echi Trascitti con successo!', 'success'); }
        function showCredits() { alert(`✨ ASTRA MYSTERIUM - Oracoli Celesti ✨\n\n📜 Custodi del Sapere (Crediti):\n• Concetto e Sviluppo: Ispirato dalle Stelle (e da te!)\n• Tecnologie: HTML, CSS, JavaScript, Canvas Confetti\n\n🗝️ Portali Cosmici (Funzionalità):\n• Autenticazione Astrale (Simulata)\n• Modalità Spettro (Ospite)\n• Cronache Celesti Personalizzate (Statistiche)\n• Salvataggio Echi nel Local Storage\n\n🔮 Giochi Oracolari:\n• Numerologia Astrale (Indovina Numero)\n• Memoria Stellare (Memory Game)\n• Sequenza Astrale (Pattern - In Sviluppo)\n• Enigma delle Rune (Logica - In Sviluppo)\n• Cometa Fulminea, Armonia Cromatica (Placeholder)\n\n🎨 Visioni Astrali (Caratteristiche):\n• Molteplici Temi Celesti Dinamici\n• Grafica Immersiva con Effetti Cosmici\n• UI "Cristallo Divinatorio" e "Bagliore Celestiale"\n• Melodie Celesti (Musica di Sottofondo)\n• Design Adattivo per Viaggi Interdimensionali (Responsivo)\n• Configurazione Flusso Energetico (Prestazioni)\n\n🌌 Arena Eterea (Multiplayer):\n• Accesso tramite portale 'index.html' (Simulato)\n\n🎵 Armonie Celesti (Audio):\n• Supporto per musica.mp3\n• Controllo Volume e Attivazione/Disattivazione\n\nVersione Ω.1 (Omega Potenziata) - L'Universo è in Continua Espansione\nCreato con Polvere di Stelle e Codice Arcano!`); }
        
        // Navigation Functions (showMainMenu, showGameMode, showSettings, hideAllScreens) - invariate
        function showMainMenu() { hideAllScreens(); document.getElementById('mainMenu').classList.remove('hidden'); loadStats(); }
        function showGameMode(mode) { hideAllScreens(); document.getElementById(mode)?.classList.remove('hidden'); gameState.currentGame = mode; }
        function showSettings() { hideAllScreens(); document.getElementById('settings').classList.remove('hidden'); }
        function hideAllScreens() { ['mainMenu', 'numberQuest', 'memoryChallenge', 'astralSequence', 'runeEnigma', 'reactionTime', 'patternMaster', 'colorMatch', 'quickMath', 'settings'].forEach(id => { document.getElementById(id)?.classList.add('hidden'); }); }

        // Number Quest Functions (selectDifficulty, startNumberQuest, ecc.) - invariate
        function selectDifficulty(diff) { gameState.numberQuest.difficulty = diff; document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.difficulty-btn[data-difficulty="${diff}"]`)?.classList.add('active'); }
        function startNumberQuest() {
    const nq = gameState.numberQuest;
    const config = numberQuestDifficulties[nq.difficulty];
    const levelConf = config.levels[nq.currentLevel - 1];

    nq.secretNumber = Math.floor(Math.random() * (levelConf.max - levelConf.min + 1)) + levelConf.min;
    nq.attemptsLeft = config.attempts;
    nq.maxAttempts = config.attempts;
    nq.levelScore = 0;
    nq.gameStarted = true;
    nq.history = [];

    ['submitGuess', 'guessInput'].forEach(id => document.getElementById(id).disabled = false); // 🔧 Questa linea è fondamentale

    const timerDisp = document.getElementById('timerDisplay');
    if (config.hasTimer) {
        nq.timeLeft = config.timeLimit;
        startNumberQuestTimer();
    }

    updateNumberQuestDisplay();
    document.getElementById('numberGameArea')?.classList.remove('hidden');
    document.getElementById('guessInput').value = '';
    setTimeout(() => document.getElementById('guessInput')?.focus(), 100);
}

        function startNumberQuestTimer() { const nq = gameState.numberQuest; if(nq.timer) clearInterval(nq.timer); nq.timer = setInterval(() => { nq.timeLeft--; const timerDisp = document.getElementById('timerDisplay'); if(timerDisp) timerDisp.textContent = nq.timeLeft; if (nq.timeLeft <= 10) timerDisp?.classList.add('timer-warning'); if (nq.timeLeft <= 0) { clearInterval(nq.timer); endNumberQuestLevel(false); } }, 1000); }
        function makeGuess() { const nq = gameState.numberQuest; if (!nq.gameStarted) return; const guessInput = document.getElementById('guessInput'); const guess = parseInt(guessInput.value); const config = numberQuestDifficulties[nq.difficulty]; const levelConf = config.levels[nq.currentLevel - 1]; if (isNaN(guess) || guess < levelConf.min || guess > levelConf.max) { return showHint(`❌ Sussurra un numero tra ${levelConf.min} e ${levelConf.max}!`); } nq.attemptsLeft--; let hintText = '', correct = false; if (guess === nq.secretNumber) { hintText = '🎉 Allineamento Perfetto! Sfera Conquistata!'; correct = true; const base = levelConf.max, attBonus = nq.attemptsLeft * 25, timeBonus = config.hasTimer ? nq.timeLeft * 10 : 0; nq.levelScore = base + attBonus + timeBonus; nq.score += nq.levelScore; if (typeof confetti !== 'undefined' && !settings.reduceAnimations) { const themeConfettiColors = (THEME_DETAILS[settings.theme] || THEME_DETAILS['starlight-oracle']).colors; confetti({ particleCount: 150, spread: 90, origin: { y: 0.5 }, angle: Math.random()*120+30, drift: Math.random()*2-1, colors: [themeConfettiColors.primary, themeConfettiColors.secondary, themeConfettiColors.accent, '#FFFFFF', '#DDDDDD'] }); } endNumberQuestLevel(true); } else { const diff = Math.abs(nq.secretNumber - guess); const rangePerc = (val) => (levelConf.max - levelConf.min) * val; if (guess < nq.secretNumber) { if (diff <= rangePerc(0.05)) hintText = '🔥 Calore Stellare! PIÙ ALTO!'; else if (diff <= rangePerc(0.15)) hintText = '📈 Ascendi! PIÙ ALTO!'; else if (diff <= rangePerc(0.40)) hintText = '⬆️ Verso le vette! MOLTO PIÙ ALTO!'; else hintText = '🚀 Oltre le nebulose! DECISAMENTE PIÙ ALTO!'; } else { if (diff <= rangePerc(0.05)) hintText = '🔥 Vicinissimo! PIÙ BASSO!'; else if (diff <= rangePerc(0.15)) hintText = '📉 Discendi! PIÙ BASSO!'; else if (diff <= rangePerc(0.40)) hintText = '⬇️ Nelle profondità! MOLTO PIÙ BASSO!'; else hintText = '🕳️ Nel vuoto! DECISAMENTE PIÙ BASSO!'; } } nq.history.unshift({ guess, hint: hintText, attemptsLeft: nq.attemptsLeft }); showHint(hintText); updateNumberQuestDisplay(); updateNumberQuestHistory(); if (nq.attemptsLeft <= 0 && !correct) endNumberQuestLevel(false); guessInput.value = ''; setTimeout(() => guessInput.focus(), 50); }
        function endNumberQuestLevel(won) { const nq = gameState.numberQuest; nq.gameStarted = false; if(nq.timer) clearInterval(nq.timer); ['submitGuess', 'guessInput'].forEach(id => document.getElementById(id).disabled = true); if (won) { if (nq.currentLevel < 10) { showHint(`🎊 Sfera ${nq.currentLevel} conquistata! Armonia: +${nq.levelScore}. Prossima sfera...`); setTimeout(() => { nq.currentLevel++; startNumberQuest(); }, 2800); } else { showHint(`🏆 RITUALE COMPLETATO! Armonia Totale: ${nq.score}`); saveStats(true, nq.score); showNotification('🏆 Numerologia Astrale Padronizzata!', 'success'); setTimeout(() => { resetNumberQuest(); showMainMenu(); }, 3800); } } else { showHint(`💀 Dissonanza! Il Numero Arcano era ${nq.secretNumber}. Armonia Totale: ${nq.score}`); saveStats(false, nq.score); showNotification('💀 Le stelle non erano allineate...', 'error'); setTimeout(resetNumberQuest, 3200); } }
        function resetNumberQuest() { const nq = gameState.numberQuest; if(nq.timer) clearInterval(nq.timer); nq.secretNumber = 0; nq.attemptsLeft = 10; nq.maxAttempts = 10; nq.score = 0; nq.levelScore = 0; nq.currentLevel = 1; nq.gameStarted = false; nq.history = []; nq.timer = null; nq.timeLeft = 40; ['submitGuess', 'guessInput'].forEach(id => document.getElementById(id).disabled = false); document.getElementById('guessInput').value = ''; showHint('Il cosmo attende la tua intuizione...'); document.getElementById('history').innerHTML = ''; document.getElementById('timerDisplay')?.classList.remove('timer-warning'); document.getElementById('levelProgress')?.classList.add('hidden'); document.getElementById('numberGameArea')?.classList.add('hidden'); updateNumberQuestDisplay(); }
        function updateNumberQuestDisplay() { const nq = gameState.numberQuest; const config = numberQuestDifficulties[nq.difficulty]; const levelConf = config.levels[nq.currentLevel - 1]; ['attemptsLeft', 'currentScore', 'levelScore', 'currentLevel'].forEach(id => { document.getElementById(id).textContent = nq[id.replace('currentL', 'currentL')]; }); document.getElementById('levelRange').textContent = `Eco: ${levelConf.min}-${levelConf.max}`; document.getElementById('levelFill').style.width = (nq.currentLevel / 10 * 100) + '%'; const guessInput = document.getElementById('guessInput'); guessInput.min = levelConf.min; guessInput.max = levelConf.max; guessInput.placeholder = `Numero (${levelConf.min}-${levelConf.max})`; document.getElementById('currentNumber').textContent = (!nq.gameStarted && nq.secretNumber > 0) ? nq.secretNumber : '?'; }
        function updateNumberQuestHistory() { const histEl = document.getElementById('history'); histEl.innerHTML = ''; gameState.numberQuest.history.forEach(entry => { const item = document.createElement('div'); item.className = 'history-item'; item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:bold;color:var(--accent);">Congiunzione ${gameState.numberQuest.maxAttempts - entry.attemptsLeft}</span> <span style="font-size:1.2rem;font-weight:bold;color:var(--primary);">${entry.guess}</span></div><div style="margin-top:0.5rem;color:var(--text-dim);font-size:0.9em;">${entry.hint}</div>`; histEl.appendChild(item); }); }
        function showHint(msg) { document.getElementById('hint').textContent = msg; }

        // Memory Game Functions (startMemoryGame, generateMemoryCards, ecc.) - invariate
        const memorySymbols = ['☉', '☽', '☿', '♀', '♂', '♃', '♄', '♅', '♆', '♇', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓'];
        function startMemoryGame() { const mg = gameState.memoryGame; if(mg.timer) clearInterval(mg.timer); mg.pairsFound = 0; mg.moves = 0; mg.time = 0; mg.flippedCardsElements = []; mg.matchedPairs = 0; generateMemoryCards(); updateMemoryDisplay(); mg.timer = setInterval(() => { mg.time++; document.getElementById('memoryTime').textContent = mg.time; }, 1000); }
        function generateMemoryCards() { const mg = gameState.memoryGame; const grid = document.getElementById('memoryGrid'); const numPairs = (mg.gridSize * mg.gridSize) / 2; let symbolsPool = [...memorySymbols]; for (let i = symbolsPool.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [symbolsPool[i], symbolsPool[j]] = [symbolsPool[j], symbolsPool[i]]; } let symbolsForGame = symbolsPool.slice(0, numPairs); mg.cards = [...symbolsForGame, ...symbolsForGame]; for (let i = mg.cards.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [mg.cards[i], mg.cards[j]] = [mg.cards[j], mg.cards[i]]; } grid.innerHTML = ''; grid.style.gridTemplateColumns = `repeat(${mg.gridSize}, 1fr)`; mg.cards.forEach((symbol, index) => { const card = document.createElement('div'); card.className = 'memory-card'; card.dataset.index = index; card.dataset.symbol = symbol; card.innerHTML = `<div class="card-face card-front"></div><div class="card-face card-back"><div>${symbol}</div></div>`; card.onclick = () => flipMemoryCard(card); grid.appendChild(card); }); }
        function flipMemoryCard(cardEl) { const mg = gameState.memoryGame; if (mg.flippedCardsElements.length >= 2 || cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) return; cardEl.classList.add('flipped'); mg.flippedCardsElements.push(cardEl); if (mg.flippedCardsElements.length === 2) { mg.moves++; updateMemoryDisplay(); setTimeout(checkMemoryMatch, 900); } }
        function checkMemoryMatch() { const mg = gameState.memoryGame; const [card1, card2] = mg.flippedCardsElements; if (card1.dataset.symbol === card2.dataset.symbol) { [card1, card2].forEach(c => { c.classList.add('matched'); c.classList.remove('flipped'); }); mg.matchedPairs++; if (mg.matchedPairs === (mg.gridSize * mg.gridSize) / 2) { clearInterval(mg.timer); if (typeof confetti !== 'undefined' && !settings.reduceAnimations) { const themeConfettiColors = (THEME_DETAILS[settings.theme] || THEME_DETAILS['starlight-oracle']).colors; confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: [themeConfettiColors.primary, themeConfettiColors.accent, '#FFFFFF'] }); } setTimeout(() => { showNotification(`🎉 Costellazione Completata! Tempo: ${mg.time}s, Intuizioni: ${mg.moves}`, 'success'); saveStats(true, (mg.gridSize*100) - mg.moves - mg.time); startMemoryGame(); }, 1200); } } else { [card1, card2].forEach(c => c.classList.remove('flipped')); } mg.flippedCardsElements = []; updateMemoryDisplay(); }
        function updateMemoryDisplay() { const mg = gameState.memoryGame; document.getElementById('memoryLevel').textContent = mg.level; document.getElementById('memoryPairs').textContent = mg.matchedPairs; document.getElementById('memoryMoves').textContent = mg.moves; }

    </script>
</body>
</html>
